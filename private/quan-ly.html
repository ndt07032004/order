<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∂NG NG√ÇN</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        /* ... (GI·ªÆ NGUY√äN CSS) ... */
        :root { --bg-body: #F4F7FE; --panel-bg: rgba(255, 255, 255, 0.9); --primary-gradient: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); --accent-gradient: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); --primary-solid: #FF6B6B; --text-heading: #2D3436; --text-body: #636E72; --text-light: #B2BEC3; --border: 1px solid rgba(255, 255, 255, 0.6); --shadow-soft: 0 10px 40px rgba(226, 232, 240, 0.8); --radius: 24px; --sidebar-width: 80px; --sidebar-width-hover: 240px; }
        * { box-sizing: border-box; }
        body { font-family: 'Be Vietnam Pro', sans-serif; display: flex; height: 100vh; margin: 0; background-color: var(--bg-body); color: var(--text-heading); overflow: hidden; background-image: radial-gradient(at 0% 0%, rgba(255, 154, 158, 0.1) 0, transparent 50%), radial-gradient(at 100% 100%, rgba(255, 107, 107, 0.1) 0, transparent 50%); }
        h1, h2, h3, h4, .btn-main, .nav-item { font-family: 'Outfit', sans-serif; }
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #D1D8E0; border-radius: 10px; }
        
        .sidebar { width: var(--sidebar-width); background: var(--panel-bg); backdrop-filter: blur(20px); border-right: var(--border); display: flex; flex-direction: column; padding: 20px 15px; z-index: 100; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 5px 0 25px rgba(0,0,0,0.03); overflow: hidden; }
        .sidebar:hover { width: var(--sidebar-width-hover); }
        .logo-area { height: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; white-space: nowrap; overflow: hidden; }
        .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary-solid); background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; opacity: 0; transition: 0.2s; }
        .sidebar:hover .logo { opacity: 1; }
        .logo-icon { position: absolute; left: 24px; font-size: 1.8rem; }
        .nav-list { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .nav-item { padding: 14px; border-radius: 16px; color: var(--text-body); display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; white-space: nowrap; position: relative; }
        .nav-item i { font-style: normal; font-size: 1.5rem; min-width: 24px; text-align: center; }
        .nav-item span { opacity: 0; transition: 0.2s; font-weight: 600; transform: translateX(-10px); }
        .sidebar:hover .nav-item span { opacity: 1; transform: translateX(0); }
        .nav-item:hover { background: #FFF5F5; color: var(--primary-solid); }
        .nav-item.active { background: var(--accent-gradient); color: white; box-shadow: 0 10px 20px -5px rgba(255, 107, 107, 0.4); }
        .nav-logout { margin-top: auto; background: #F8F9FA; color: var(--danger); }
        .nav-logout:hover { background: #FFF0F0; }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 20px; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: flex; flex-direction: column; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-grid { display: grid; grid-template-columns: 320px 1fr 380px; gap: 20px; height: 100%; }
        .panel { background: var(--panel-bg); backdrop-filter: blur(20px); border-radius: var(--radius); padding: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow-soft); border: 2px solid #FFFFFF; }
        .panel-header { font-weight: 800; font-size: 1.1rem; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: var(--text-heading); }

        #order-list { overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-right: 5px; }
        .order-card { background: #FFFFFF; border-radius: 16px; padding: 15px; border: 1px solid #F0F0F0; border-left: 5px solid var(--primary-solid); transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); position: relative; }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        .order-card.paid { border-left-color: var(--success); background: #F6FFFA; opacity: 0.7; }
        .order-meta { display: flex; justify-content: space-between; font-weight: 700; color: var(--text-heading); margin-bottom: 8px; font-size: 0.9rem; }
        .order-items div { display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--text-body); font-size: 0.9rem; }

        .center-col { display: flex; flex-direction: column; gap: 20px; height: 100%; overflow: hidden; }
        .table-area { max-height: 250px; overflow-y: auto; background: transparent; padding: 0; box-shadow: none; border: none; }
        .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .table-btn { background: white; border: 2px solid transparent; padding: 20px 5px; border-radius: 18px; text-align: center; cursor: pointer; font-weight: 700; transition: 0.2s; color: var(--text-body); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .table-btn:hover { transform: translateY(-3px); color: var(--primary-solid); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .table-btn.selected { background: var(--text-heading); color: white; box-shadow: 0 10px 20px rgba(45, 52, 54, 0.3); }
        .table-btn.busy { background: #FFF9C4; color: #FBC02D; box-shadow: 0 5px 15px rgba(251, 192, 45, 0.2); }
        .table-btn-add { border: 2px dashed #B2BEC3; background: transparent; color: #B2BEC3; box-shadow: none; }
        .search-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-bar { flex: 1; background: #F8F9FD; border: none; padding: 12px 15px; border-radius: 12px; font-weight: 600; outline: none; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; overflow-y: auto; padding-right: 5px; }
        .pos-item { background: white; border-radius: 16px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; height: 180px; border: 1px solid #F0F0F0; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .pos-item:hover { transform: translateY(-3px); border-color: var(--primary-solid); }
        .pos-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 50%; margin-bottom: 5px; }
        .pos-item b { font-size: 0.9rem; margin-bottom: 2px; line-height: 1.2; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; width: 100%; }
        .pos-item span { color: var(--primary-solid); font-weight: 800; font-size: 0.95rem; }

        /* [FIXED] CART ITEM & REMOVE BUTTON */
        #cart-list { flex: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #F8F9FD; border-radius: 12px; margin-bottom: 8px; }
        .qty-box { display: flex; align-items: center; gap: 5px; background: white; padding: 3px 6px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-qty-mini { cursor: pointer; font-weight: 800; color: var(--text-light); transition: 0.2s; padding: 2px 8px; font-size: 1.1rem; }
        .btn-qty-mini:hover { color: var(--primary-solid); transform: scale(1.2); }
        
        /* [TH√äM N√öT XO√Å] */
        .btn-remove { 
            color: #FF7675; cursor: pointer; margin-left: 10px; font-size: 1.2rem; 
            padding: 5px; border-radius: 50%; transition: 0.2s;
        }
        .btn-remove:hover { background: #FFF0F0; transform: scale(1.1); }

        .btn-checkout { background: var(--accent-gradient); color: white; border: none; width: 100%; padding: 18px; border-radius: 16px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3); }
        .btn-checkout:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4); }

        .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 0; }
        .filter-chip { background: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid #EDEEF0; transition: 0.2s; font-weight: 600; color: var(--text-body); }
        .filter-chip.active { background: var(--text-heading); color: white; border-color: var(--text-heading); }

        #toast-container { position: fixed; top: 30px; right: 30px; z-index: 9999; display: flex; flex-direction: column; gap: 15px; }
        .toast { background: white; padding: 16px 24px; border-radius: 14px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); min-width: 300px; display: flex; align-items: center; gap: 15px; animation: slideIn 0.4s; border-left: 5px solid var(--primary-solid); font-weight: 600; }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        .full-page-tab { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 100%; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 5px; }
        th { text-align: left; padding: 12px; color: var(--text-light); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; }
        td { padding: 12px; background: #FAFAFA; font-weight: 500; font-size: 0.95rem; }
        td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        .btn-main { background: var(--text-heading); color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 700; margin-top: 15px; }
        input, select { background: #F8F9FD; border: none; padding: 12px; border-radius: 10px; width: 100%; outline: none; margin-top: 5px; }
        
        .chart-container { position: relative; height: 60vh; width: 100%; margin-top: 20px; }
        .stats-controls { margin-top: 20px; background: #FAFAFA; padding: 15px; border-radius: 16px; display: flex; gap: 10px; }

        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: white; color: black; z-index: 9999; padding: 20px; display: block !important; } }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="sidebar">
    <div class="logo-area">
        <span class="logo-icon">‚òï</span>
        <span class="logo">ƒêƒÉng Ng√¢n</span>
    </div>
    
    <div class="nav-list">
        <div class="nav-item active" onclick="switchTab('dashboard')"><i>‚ö°</i> <span>Order</span></div>
        <div class="nav-item" onclick="switchTab('menu')"><i>üçî</i> <span>Th·ª±c ƒê∆°n</span></div>
        <div class="nav-item" onclick="switchTab('stats')"><i>üìà</i> <span>Th·ªëng K√™</span></div>
    </div>

    <div class="nav-item nav-logout" onclick="window.location.href='/'">
        <i>üö™</i> <span>ƒêƒÉng Xu·∫•t</span>
    </div>
</div>

<div class="main">
    
    <div id="dashboard" class="tab-content active">
        <div class="dashboard-grid">
            
            <div class="panel">
                <div class="panel-header">üîî ƒê∆°n ch·ªù <span style="font-size:0.8rem; background:#FFF0F0; color:var(--primary-solid); padding:4px 10px; border-radius:20px;" id="order-count">0</span></div>
                <div id="order-list"></div>
            </div>

            <div class="center-col">
                <div class="panel table-area">
                    <div class="panel-header" style="margin-bottom:10px;">S∆° ƒë·ªì b√†n</div>
                    <div class="table-grid" id="tables-ui"></div>
                </div>
                
                <div class="panel menu-area">
                    <div class="search-row">
                        <input type="text" id="pos-search" class="search-bar" placeholder="üîç T√¨m nhanh..." onkeyup="renderPosMenu()">
                        <div class="filters">
                            <div class="filter-chip active" onclick="filterMenu('all', this)">All</div>
                            <div class="filter-chip" onclick="filterMenu('Drink', this)">N∆∞·ªõc</div>
                            <div class="filter-chip" onclick="filterMenu('Snack', this)">ƒÇn v·∫∑t</div>
                            <div class="filter-chip" onclick="filterMenu('Grocery', this)">T·∫°p h√≥a</div>
                        </div>
                    </div>
                    <div id="pos-menu" class="product-grid"></div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" id="pos-header" style="color:var(--primary-solid)">Ch∆∞a ch·ªçn b√†n</div>
                <div id="cart-list"></div>
                <div style="margin-top: auto; padding-top: 15px; border-top: 2px dashed #EDEEF0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 15px; font-size: 1.4rem; font-weight: 800;">
                        <span>T·ªïng c·ªông</span> <span id="cart-total" style="color:var(--primary-solid);">0ƒë</span>
                    </div>
                    <button class="btn-checkout" onclick="checkout()">THANH TO√ÅN & BILL üñ®Ô∏è</button>
                </div>
            </div>

        </div>
    </div>

    <div id="menu" class="tab-content">
        <div class="full-page-tab">
            <div class="panel">
                <h3 style="margin-top:0; color:var(--primary-solid);">‚ú® Th√™m m√≥n m·ªõi</h3>
                <form id="product-form" action="/api/products" method="POST" enctype="multipart/form-data">
                    <input type="hidden" id="edit-id" name="id">
                    <label style="display:block; margin-top:10px; font-weight:600;">T√™n m√≥n:</label> 
                    <input type="text" id="p-name" name="name" required>
                    <label style="display:block; margin-top:10px; font-weight:600;">Gi√° b√°n:</label> 
                    <input type="number" id="p-price" name="price" required>
                    <label style="display:block; margin-top:10px; font-weight:600;">Ph√¢n lo·∫°i:</label>
                    <select id="p-category" name="category">
                        <option value="Drink">‚òï ƒê·ªì u·ªëng</option>
                        <option value="Snack">üç∞ ƒê·ªì ƒÉn v·∫∑t</option>
                        <option value="Grocery">üõí T·∫°p h√≥a</option>
                    </select>
                    <label style="display:block; margin-top:10px; font-weight:600;">H√¨nh ·∫£nh:</label> 
                    <input type="file" name="image" accept="image/*">
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button type="submit" id="btn-submit" class="btn-main" style="background:var(--accent-gradient); color:white;">L∆ØU M√ìN</button>
                        <button type="button" id="btn-cancel" class="btn-main" style="background:#DFE6E9; color:#636E72; display:none;" onclick="resetForm()">H·ª¶Y</button>
                    </div>
                </form>
            </div>
            <div class="panel" style="background:transparent; box-shadow:none; border:none; padding:0;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">üìã Danh s√°ch th·ª±c ƒë∆°n</h3>
                    <input type="text" id="admin-search" placeholder="T√¨m ki·∫øm..." style="width:250px; padding:10px; border-radius:12px; border:none; outline:none; background:white;" onkeyup="renderAdminTable()">
                </div>
                <div style="overflow-y:auto; height:100%; border-radius:16px;">
                    <table><thead><tr><th>·∫¢nh</th><th>T√™n m√≥n</th><th>Gi√° b√°n</th><th>Lo·∫°i</th><th>TT</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody id="menu-table"></tbody></table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="stats" class="tab-content">
        <div class="panel" style="margin: 0 auto; width: 95%; height: 95%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üìà B√°o c√°o doanh thu</h3><div class="total-revenue" id="stats-total" style="margin:0; font-size:1.8rem;">0ƒë</div>
            </div>
            <div class="stats-controls">
                <select id="stats-type" onchange="updateStatsInput()" style="width: 150px; background:white;">
                    <option value="daily">Theo Ng√†y</option><option value="monthly">Theo Th√°ng</option><option value="yearly">Theo NƒÉm</option>
                </select>
                <div id="stats-input-container" style="display:flex; gap:10px;">
                    <select id="stats-month" style="background:white;"></select><select id="stats-year" style="background:white;"></select>
                </div>
                <button class="btn-main" style="width:120px; margin:0; padding:10px; background:var(--accent-gradient); color:white;" onclick="loadStats()">Xem B√°o C√°o</button>
            </div>
            <div class="chart-container"><canvas id="revenueChart"></canvas></div>
        </div>
    </div>

</div>

<div id="print-area" style="display:none;">
    <div style="text-align:center; font-weight:bold; font-size: 24px; margin-bottom: 5px;">TRAM COFFEE</div>
    <div style="text-align:center; font-size: 14px; margin-bottom: 15px;">ƒêC: Hi·ªáp Ho√†</div>
    <div style="text-align:center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom:10px;">
        <h2 style="margin:0;">H√ìA ƒê∆†N </h2>
    </div>
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span id="print-table" style="font-weight:bold;">B√†n: ...</span>
        <span id="print-date">...</span>
    </div>
    <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin-bottom: 15px;">
        <div id="print-items" style="line-height: 1.8; font-size: 16px;"></div>
    </div>
    <div style="text-align:right; font-size: 22px; font-weight:bold; margin-bottom:30px;">
        T·ªïng ti·ªÅn: <span id="print-total">...</span>
    </div>
    <p style="text-align:center; font-style: italic;">C·∫£m ∆°n qu√Ω kh√°ch & H·∫πn g·∫∑p l·∫°i!</p>
</div>

<audio id="beep" src="/beep.mp3"></audio>

<script>
    const socket = io();
    let products = [], cart = [], currentTable = null;
    let revenueChart = null; 
    let currentFilter = 'all';
    let totalTables = parseInt(localStorage.getItem('tableCount')) || 12;

    function showToast(msg, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${type==='success'?'üéâ':'‚ö†Ô∏è'}</span> <span>${msg}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function updateOrderCount() {
        const count = document.querySelectorAll('#order-list .order-card').length;
        const badge = document.getElementById('order-count');
        if(badge) badge.innerText = count;
    }

    window.onload = async () => {
        renderTables();
        await loadData();
        await syncBusyTables();
        initStatsControls();
    };

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        const navs = document.querySelectorAll('.nav-item');
        if(id === 'dashboard') navs[0].classList.add('active');
        if(id === 'menu') navs[1].classList.add('active');
        if(id === 'stats') navs[2].classList.add('active');
    }

    function renderTables() {
        const div = document.getElementById('tables-ui');
        let html = `<button class="table-btn" id="t-0" onclick="selectTbl('0', true)">ü•° Order</button>`;
        for(let i=1; i<=totalTables; i++) {
            html += `<button class="table-btn" id="t-${i}" onclick="selectTbl('${i}', false)">B√†n ${i}</button>`;
        }
        html += `<button class="table-btn table-btn-add" onclick="addTable()">‚ûï</button>`;
        div.innerHTML = html;
    }

    function addTable() {
        totalTables++;
        localStorage.setItem('tableCount', totalTables);
        renderTables();
        syncBusyTables();
        showToast(`ƒê√£ th√™m B√†n ${totalTables}`);
    }

    async function selectTbl(name, isTakeAway) {
        currentTable = { name, isTakeAway };
        
        document.querySelectorAll('.table-btn').forEach(b => b.classList.remove('selected'));
        const btnId = (name === '0' || name === 0) ? 't-0' : `t-${name}`;
        const btn = document.getElementById(btnId);
        if(btn) btn.classList.add('selected');
        
        const displayLabel = (name === '0' || name === 0) ? "ü•° ƒê∆°n Order" : `B√†n ${name}`;
        document.getElementById('pos-header').innerText = displayLabel;
        
        cart = [];
        try {
            const res = await fetch(`/api/orders/pending/${name}`);
            const order = await res.json();
            if (order && order.items) {
                cart = order.items.map(i => ({ productName: i.productName, price: i.price, quantity: i.quantity }));
            }
        } catch (e) { console.error(e); }
        
        renderCart();
    }

    function updatePosItem(name, price, delta) {
        if(!currentTable) return showToast("Vui l√≤ng ch·ªçn b√†n tr∆∞·ªõc!", "error");
        
        // N·∫øu x√≥a s·ªë l∆∞·ª£ng xu·ªëng 0 -> X√≥a m√≥n ƒë√≥
        // (Server s·∫Ω x·ª≠ l√Ω vi·ªác x√≥a m√≥n trong DB, ·ªü ƒë√¢y ch·ªâ g·ª≠i request)
        
        socket.emit('send_order', { 
            tableNumber: currentTable.name, 
            items: [{ productName: name, price: price, quantity: delta }], 
            totalAmount: price * delta, // S·ªë ti·ªÅn thay ƒë·ªïi
            isTakeAway: currentTable.isTakeAway, 
            status: 'pending' 
        });
    }
    function addToCart(name, price) { updatePosItem(name, price, 1); }

    // [FIXED] Render Cart v·ªõi n√∫t X√≥a
    function renderCart() {
        let total = 0;
        const validItems = cart.filter(i => i.quantity > 0);
        document.getElementById('cart-list').innerHTML = validItems.map(i => {
            total += i.price * i.quantity;
            return `<div class="cart-item">
                <div style="flex:1"><b>${i.productName}</b><br><small style="color:var(--text-light)">${i.price.toLocaleString()}</small></div>
                <div class="qty-box">
                    <div class="btn-qty-mini" onclick="updatePosItem('${i.productName}', ${i.price}, -1)">-</div>
                    <span style="font-weight:bold; min-width:20px; text-align:center;">${i.quantity}</span>
                    <div class="btn-qty-mini" onclick="updatePosItem('${i.productName}', ${i.price}, 1)">+</div>
                </div>
                <div class="btn-remove" onclick="updatePosItem('${i.productName}', ${i.price}, -${i.quantity})">üóëÔ∏è</div>
                <div style="margin-left:10px; font-weight:bold; color:var(--primary-solid); min-width:70px; text-align:right;">${(i.price*i.quantity).toLocaleString()}</div>
            </div>`;
        }).join('');
        document.getElementById('cart-total').innerText = total.toLocaleString() + 'ƒë';
    }

    function filterMenu(cat, el) { 
        currentFilter = cat; 
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        if(el) el.classList.add('active');
        renderPosMenu(); 
    }

    function renderPosMenu() {
        const keyword = document.getElementById('pos-search').value.toLowerCase();
        const filtered = products.filter(p => {
            const matchCat = currentFilter === 'all' || p.category === currentFilter;
            const matchName = p.name.toLowerCase().includes(keyword);
            return matchCat && matchName;
        });
        document.getElementById('pos-menu').innerHTML = filtered.map(p => `
            <div class="pos-item" onclick="addToCart('${p.name}', ${p.price})">
                <img src="${p.image}" onerror="this.src='https://placehold.co/100/F3F5F9/B2BEC3?text=IMG'">
                <div><b>${p.name}</b><br><span>${p.price.toLocaleString()}</span></div>
            </div>
        `).join('');
    }

    // --- SHARED ---
    async function loadData() {
        const res = await fetch('/api/admin/products');
        products = await res.json();
        renderPosMenu();
        renderAdminTable();
    }
    
    async function syncBusyTables() {
        const res = await fetch('/api/orders/pending-all');
        const busyOrders = await res.json();
        document.querySelectorAll('.table-btn').forEach(b => b.classList.remove('busy'));
        busyOrders.forEach(o => {
            const btnId = (o.tableNumber === '0' || o.tableNumber === 0) ? 't-0' : `t-${o.tableNumber}`;
            const btn = document.getElementById(btnId);
            if(btn) btn.classList.add('busy');
        });
        updateOrderCount();
    }
    
    // --- ADMIN TABLE (Gi·ªØ nguy√™n) ---
    function renderAdminTable() {
        const keyword = document.getElementById('admin-search').value.toLowerCase();
        const filtered = products.filter(p => p.name.toLowerCase().includes(keyword));
        document.getElementById('menu-table').innerHTML = filtered.map(p => `<tr><td><img src="${p.image}" style="width:40px"></td><td>${p.name}</td><td>${p.price}</td><td>${p.category}</td><td>${p.isVisible?'H':'·∫®n'}</td><td><button onclick="editProduct('${p._id}')">‚úèÔ∏è</button> <button onclick="del('${p._id}')">üóëÔ∏è</button></td></tr>`).join('');
    }
    function editProduct(id) { const p = products.find(i=>i._id===id); if(p){ document.getElementById('edit-id').value=p._id; document.getElementById('p-name').value=p.name; document.getElementById('p-price').value=p.price; } }
    function resetForm() { document.getElementById('edit-id').value=''; document.getElementById('p-name').value=''; }
    async function toggle(id) { await fetch(`/api/products/toggle/${id}`, { method: 'POST' }); loadData(); }
    async function del(id) { if(confirm("X√≥a?")) { await fetch(`/api/products/${id}`, { method: 'DELETE' }); loadData(); } }

    // --- CHECKOUT ---
    function checkout() {
        if(!currentTable || cart.length === 0) return showToast("B√†n tr·ªëng!", "error");
        
        const total = document.getElementById('cart-total').innerText;
        const tableName = (currentTable.name == '0') ? 'Order' : `B√†n ${currentTable.name}`;
        
        document.getElementById('print-table').innerText = tableName;
        document.getElementById('print-date').innerText = `Ng√†y: ${new Date().toLocaleString('vi-VN')}`;
        document.getElementById('print-total').innerText = `T·ªîNG: ${total}`;
        
        const validItems = cart.filter(i => i.quantity > 0);
        document.getElementById('print-items').innerHTML = validItems.map(i => 
            `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i.productName} (x${i.quantity})</span><span>${(i.price*i.quantity).toLocaleString()}</span></div>`
        ).join('');

        socket.emit('pay_order', { tableNumber: currentTable.name });
        showToast("Thanh to√°n th√†nh c√¥ng!", "success");
        setTimeout(() => { window.print(); }, 500);
    }

    // --- STATS ---
    function initStatsControls() {
        const d = new Date();
        const m = document.getElementById('stats-month'); for(let i=1;i<=12;i++) m.innerHTML+=`<option value="${i}" ${i===d.getMonth()+1?'selected':''}>T${i}</option>`;
        const y = document.getElementById('stats-year'); for(let i=2024;i<=d.getFullYear()+1;i++) y.innerHTML+=`<option value="${i}" ${i===d.getFullYear()?'selected':''}>${i}</option>`;
        updateStatsInput();
    }
    function updateStatsInput() { document.getElementById('stats-month').style.display = document.getElementById('stats-type').value==='daily'?'block':'none'; }
    async function loadStats() {
        const t = document.getElementById('stats-type').value;
        const m = document.getElementById('stats-month').value;
        const y = document.getElementById('stats-year').value;
        const res = await fetch(`/api/stats/revenue?type=${t}&month=${m}&year=${y}`);
        const data = await res.json();
        if(revenueChart) revenueChart.destroy();
        const ctx = document.getElementById('revenueChart').getContext('2d');
        revenueChart = new Chart(ctx, { type: 'bar', data: { labels: data.map(i=>i._id), datasets: [{ label: 'Doanh thu', data: data.map(i=>i.total), backgroundColor: '#FF6B6B' }] } });
        document.getElementById('stats-total').innerText = data.reduce((a,b)=>a+b.total,0).toLocaleString() + 'ƒë';
    }

    // --- SOCKET LOGIC FIX ---
    socket.on('new_order_to_admin', (order) => {
        document.getElementById('beep').play();
        const existing = document.getElementById(`order-${order._id}`);
        const hasItems = order.items && order.items.some(i => i.quantity > 0);
        
        if (hasItems && order.status !== 'deleted') {
            const tableName = (order.tableNumber == '0') ? 'ü•° Order' : `B√†n ${order.tableNumber}`;
            const html = `
            <div id="order-${order._id}" class="order-card ${order.status}">
                <div class="order-meta"><span>${tableName}</span> <span>${new Date(order.createdAt).toLocaleTimeString()}</span></div>
                <div class="order-items">
                    ${order.items.filter(i=>i.quantity>0).map(i => `<div><span>${i.productName}</span> <b>x${i.quantity}</b></div>`).join('')}
                </div>
                ${order.status === 'paid' ? '<div style="text-align:right; color:var(--success); font-weight:700;">ƒê√É THANH TO√ÅN</div>' : ''}
            </div>`;
            if (existing) existing.outerHTML = html;
            else if (order.status !== 'paid') document.getElementById('order-list').insertAdjacentHTML('afterbegin', html);
        } else if (existing) {
            existing.remove();
        }
        
        updateOrderCount();

        // [FIX] N·∫øu ƒë∆°n b·ªã x√≥a (h·∫øt m√≥n) -> B·ªè tr·∫°ng th√°i busy
        const btnId = (order.tableNumber == '0') ? 't-0' : `t-${order.tableNumber}`;
        const btn = document.getElementById(btnId);
        
        if (order.status === 'deleted' || !hasItems) {
            if(btn) btn.classList.remove('busy');
        } else if(order.status === 'pending') {
            if(btn) btn.classList.add('busy');
        }

        // C·∫≠p nh·∫≠t gi·ªè h√†ng realtime
        if(currentTable && currentTable.name == order.tableNumber) {
            cart = order.items.map(i => ({ productName: i.productName, price: i.price, quantity: i.quantity }));
            renderCart();
        }
    });

    socket.on('order_paid_success', (order) => {
        const card = document.getElementById(`order-${order._id}`);
        if(card) { card.remove(); updateOrderCount(); }
        
        const btnId = (order.tableNumber == '0') ? 't-0' : `t-${order.tableNumber}`;
        const btn = document.getElementById(btnId);
        if(btn) btn.classList.remove('busy');
        
        if(currentTable && currentTable.name == order.tableNumber) { 
            cart = []; 
            renderCart(); 
        }
    });
</script>
</body>
</html>