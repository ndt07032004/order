<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∂NG NG√ÇN - QU·∫¢N L√ù</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=Outfit:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>

<div id="security-lock" style="display:flex;">
    <div class="lock-box">
        <div class="lock-icon-box"><i class="fa-solid fa-shield-halved"></i></div>
        <h2 style="margin:0 0 10px 0; font-size: 1.8rem;">B·∫£o M·∫≠t H·ªá Th·ªëng</h2>
        <p style="color:var(--text-body); margin-bottom:30px; font-weight: 500;">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c·∫•p 2 ƒë·ªÉ ti·∫øp t·ª•c truy c·∫≠p.</p>
        <input type="password" id="sec-pass" class="lock-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeyup="if(event.key === 'Enter') checkSecurity()">
        <button class="btn-unlock" onclick="checkSecurity()">M·ªû KH√ìA <i class="fa-solid fa-arrow-right" style="margin-left: 10px;"></i></button>
        <p id="sec-error" style="color:#E53E3E; margin-top:20px; display:none; font-weight:700; background: #FFF5F5; padding: 10px; border-radius: 10px;"><i class="fa-solid fa-circle-exclamation"></i> M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</p>
    </div>
</div>

<div id="toast-container"></div>

<div id="confirm-modal" class="overlay-confirm">
    <div class="modal-confirm">
        <div class="modal-icon"><i class="fa-solid fa-circle-xmark"></i></div>
        <h3 style="margin-top:0; font-size: 1.5rem;">X√°c nh·∫≠n xo√° d·ªØ li·ªáu?</h3>
        <p style="color: var(--text-body); font-weight: 500;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ kh√¥i ph·ª•c. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?</p>
        <div class="btn-group-confirm">
            <button class="btn-main" onclick="closeConfirm()" style="background:#EDF2F7; color:var(--text-body); flex:1;">H·ªßy b·ªè</button>
            <button id="btn-confirm-yes" class="btn-main" style="background:#E53E3E; color:white; flex:1; box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);">X√≥a ngay</button>
        </div>
    </div>
</div>

<div class="sidebar">
    <div class="logo-area">
        <div class="logo-icon"><i class="fa-solid fa-mug-hot"></i></div>
        <div class="logo-text">ƒê·∫∂NG NG√ÇN</div>
    </div>
    <div class="nav-list">
        <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fa-solid fa-cash-register"></i> <span>B√°n H√†ng</span></div>
        <div class="nav-item" onclick="window.open('/private/bep-bar.html', '_blank')"><i class="fa-solid fa-fire-burner"></i> <span>M√†n H√¨nh B·∫øp</span></div>
        <div class="nav-item" onclick="switchTab('accounts')"><i class="fa-solid fa-users-gear"></i> <span>Nh√¢n S·ª±</span></div> 
        
        <div class="nav-item" onclick="switchTab('menu')"><i class="fa-solid fa-burger"></i> <span>Th·ª±c ƒê∆°n</span></div>
        <div class="nav-item" onclick="switchTab('history')"><i class="fa-solid fa-clock-rotate-left"></i> <span>L·ªãch S·ª≠ ƒê∆°n</span></div>
        <div class="nav-item" onclick="switchTab('stats')"><i class="fa-solid fa-chart-pie"></i> <span>B√°o C√°o</span></div>
    </div>
    <div class="nav-item" onclick="window.open('/private/nhan-vien.html', '_blank')">
        <i class="fa-solid fa-mobile-screen-button"></i> <span>Giao di·ªán NV</span>
    </div>
    <div class="nav-item nav-logout" onclick="window.location.href='/api/logout'"><i class="fa-solid fa-right-from-bracket"></i> <span>ƒêƒÉng Xu·∫•t</span></div>
</div>

<div class="main">
    
    <div id="dashboard" class="tab-content active">
        <div class="dashboard-grid">
            
            <div class="center-col" style="display:flex; flex-direction:column; gap:25px; overflow:auto;">
                <div class="panel table-area" style="flex: 0 0 auto; max-height: 320px;">
                    <div class="panel-header" style="margin-bottom:15px"><i class="fa-solid fa-map-location-dot" style="color:var(--primary); margin-right: 10px;"></i> S∆° ƒë·ªì b√†n</div>
                    <div class="table-grid" id="tables-ui" style="overflow-y: auto; max-height: calc(100% - 50px);"></div>
                </div>
                <div class="panel menu-area" style="flex:1">
                    <div id="no-table-selected">
                        <i class="fa-solid fa-hand-pointer"></i>
                        <p style="font-weight: 600; font-size: 1.1rem;">Vui l√≤ng ch·ªçn b√†n ho·∫∑c khu v·ª±c "Mang V·ªÅ"<br>ƒë·ªÉ b·∫Øt ƒë·∫ßu g·ªçi m√≥n.</p>
                    </div>

                    <div id="pos-menu-container">
                        <div class="search-row">
                            <div style="position: relative; flex: 1;">
                                <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #A0AEC0;"></i>
                                <input type="search" id="pos-search" class="form-control-search" style="padding-left: 45px;" placeholder="Nh·∫≠p t√™n m√≥n (g√µ kh√¥ng d·∫•u)..." inputmode="search" autocomplete="off" oninput="renderPosMenu()">
                            </div>
                            <div style="display:flex; gap:10px;">
                                 <div id="filter-chips"></div>
                            </div>
                        </div>
                        <div id="pos-menu" class="product-grid"></div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" style="color:var(--primary)">
                    <span id="pos-header"><i class="fa-solid fa-circle-info" style="margin-right: 10px;"></i> Ch∆∞a ch·ªçn b√†n</span>
                </div>
                <div id="cart-list"></div>
                <div class="cart-footer">
                    <textarea id="admin-notes" placeholder="Th√™m ghi ch√∫ cho ƒë∆°n (v√≠ d·ª•: Kh√¥ng cay, √≠t ƒë√°...)" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical; min-height: 50px; margin-bottom: 10px;"></textarea>
                    <div class="cart-total-row">
                        <span class="cart-total-label">T·ªïng thanh to√°n</span>
                        <span id="cart-total" class="cart-total-value">0ƒë</span>
                    </div>
                    <button class="btn-checkout" onclick="checkout()">THANH TO√ÅN NGAY <i class="fa-solid fa-print"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="accounts" class="tab-content">
        <div class="user-management-grid">
            <div class="admin-card">
                <div class="panel-header" style="color:var(--primary)">
                    <span><i class="fa-solid fa-user-plus" style="margin-right: 10px;"></i> T·∫°o T√†i Kho·∫£n Nh√¢n Vi√™n</span>
                </div>
                <form id="create-account-form" onsubmit="createAccount(event)">
                    <div class="form-group">
                        <label class="form-label">T√™n ƒëƒÉng nh·∫≠p (Username)</label>
                        <input type="text" id="new-username" class="form-control" placeholder="V√≠ d·ª•: nhanvien01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M·∫≠t kh·∫©u</label>
                        <input type="password" id="new-password" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">H·ªç t√™n ƒë·∫ßy ƒë·ªß</label>
                        <input type="text" id="new-fullname" class="form-control" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vai tr√≤ (Quy·ªÅn h·∫°n)</label>
                        <select id="new-role" class="form-control">
                            <option value="staff">üèÉ Nh√¢n vi√™n Ph·ª•c v·ª• (Order)</option>
                            <option value="kitchen">üë®‚Äçüç≥ Nh√¢n vi√™n Nh√† b·∫øp (Xem ƒë∆°n)</option>
                            <option value="admin">üîë Qu·∫£n tr·ªã vi√™n (To√†n quy·ªÅn)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-main" style="background:var(--accent-gradient); color:white; width:100%; margin-top:10px;">
                        <i class="fa-solid fa-user-check"></i> X√ÅC NH·∫¨N T·∫†O T√ÄI KHO·∫¢N
                    </button>
                </form>
            </div>

            <div class="admin-card">
                <div class="panel-header">
                    <span><i class="fa-solid fa-shield-halved" style="color:var(--text-muted); margin-right: 10px;"></i> Th√¥ng tin ph√¢n quy·ªÅn</span>
                </div>
                <div style="color: var(--text-body); line-height: 1.8; font-size: 0.95rem;">
                    <p><b style="color:var(--primary)">1. Nh√¢n vi√™n Ph·ª•c v·ª•:</b> Sau khi ƒëƒÉng nh·∫≠p s·∫Ω t·ª± ƒë·ªông chuy·ªÉn ƒë·∫øn trang giao di·ªán Order tr√™n ƒëi·ªán tho·∫°i.</p>
                    <p><b style="color:var(--primary)">2. Nh√¢n vi√™n Nh√† b·∫øp:</b> Sau khi ƒëƒÉng nh·∫≠p s·∫Ω t·ª± ƒë·ªông chuy·ªÉn ƒë·∫øn m√†n h√¨nh ƒëi·ªÅu h√†nh B·∫øp & Bar.</p>
                    <p><b style="color:var(--primary)">3. Qu·∫£n tr·ªã vi√™n:</b> C√≥ to√†n quy·ªÅn truy c·∫≠p v√†o trang qu·∫£n l√Ω n√†y (Menu, Doanh thu, Nh√¢n s·ª±).</p>
                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">
                    <p style="font-style: italic; color: var(--text-muted);"><i class="fa-solid fa-circle-info"></i> L∆∞u √Ω: B·∫°n n√™n y√™u c·∫ßu nh√¢n vi√™n ƒë·ªïi m·∫≠t kh·∫©u ngay sau khi nh·∫≠n t√†i kho·∫£n.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="menu" class="tab-content">
        <div class="full-page-tab">
            <div class="panel">
                <div class="panel-header" style="color:var(--primary)"><i class="fa-solid fa-circle-plus" style="margin-right: 10px;"></i> Th√™m/S·ª≠a M√≥n</div>
                <form id="product-form" action="/api/products" method="POST" enctype="multipart/form-data">
                    <input type="hidden" id="edit-id" name="id">
                    
                    <div class="form-group">
                        <label class="form-label">T√™n s·∫£n ph·∫©m</label>
                        <input type="text" id="p-name" name="name" class="form-control" placeholder="VD: C√† ph√™ s·ªØa ƒë√° S√†i G√≤n" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Gi√° b√°n (VNƒê)</label>
                        <input type="number" id="p-price" name="price" class="form-control" placeholder="VD: 25000" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Danh m·ª•c</label>
                        <select id="p-category" name="category" class="form-control">
                            <option value="Drink">‚òï ƒê·ªì u·ªëng</option>
                            <option value="Snack">üç∞ ƒê·ªì ƒÉn v·∫∑t</option>
                            <option value="Grocery">üõí T·∫°p h√≥a</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">H√¨nh ·∫£nh minh h·ªça</label>
                        <div class="file-upload-box" id="file-upload-box">
                            <input type="file" name="image" accept="image/*" id="file-input" onchange="previewImage(event)">
                            <div class="upload-content">
                                <div class="upload-icon-box"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                                <span class="upload-text">K√©o th·∫£ ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn ·∫£nh</span>
                            </div>
                            <img id="image-preview" src="" alt="Preview">
                        </div>
                    </div>

                    <div style="display:flex; gap:15px; margin-top:30px;">
                        <button type="submit" class="btn-main" style="background:var(--accent-gradient); color:white; flex:1; box-shadow: var(--shadow-hover);"><i class="fa-solid fa-floppy-disk"></i> L∆ØU M√ìN</button>
                        <button type="button" class="btn-main" style="background:#EDF2F7; color:var(--text-body);" onclick="resetForm()"><i class="fa-solid fa-rotate-left"></i> H·ªßy</button>
                    </div>
                </form>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span><i class="fa-solid fa-list-ul" style="color:var(--primary); margin-right: 10px;"></i> Danh s√°ch th·ª±c ƒë∆°n</span>
                    <div style="position: relative; width: 300px;">
                        <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #A0AEC0;"></i>
                        <input type="search" id="admin-search" class="form-control-search" style="padding-left: 45px; background: #F1F5F9;" placeholder="T√¨m ki·∫øm nhanh..." inputmode="search" autocomplete="off" oninput="renderAdminTable()">
                    </div>
                </div>
                <div style="overflow-y:auto; flex:1; padding-right: 5px;">
                    <table>
                        <thead>
                            <tr>
                                <th>H√¨nh ·∫£nh</th>
                                <th>T√™n m√≥n</th>
                                <th>Gi√° b√°n</th>
                                <th>Danh m·ª•c</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th style="text-align:right;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="menu-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="history" class="tab-content">
        <div class="panel" style="height:100%">
            <div class="panel-header">
                <span><i class="fa-solid fa-clock-rotate-left" style="color:var(--primary); margin-right: 10px;"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng (50 ƒë∆°n g·∫ßn nh·∫•t)</span>
                <button class="btn-main" style="background: var(--text-heading); color: white; padding: 10px 20px; font-size: 0.9rem;" onclick="loadOrderHistory()"><i class="fa-solid fa-rotate"></i> L√†m m·ªõi d·ªØ li·ªáu</button>
            </div>
            <div style="overflow-y:auto; flex:1; padding-right: 5px;">
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>M√£ ƒê∆°n</th>
                            <th>Khu v·ª±c</th>
                            <th>Th·ªùi gian</th>
                            <th>Chi ti·∫øt m√≥n (T√≥m t·∫Øt)</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="stats" class="tab-content">
        <div style="max-width: 1200px; margin: 0 auto; height: 100%; display: flex; flex-direction: column;">
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa-solid fa-coins"></i></div>
                    <div class="stat-info">
                        <h3 id="stats-total">0ƒë</h3>
                        <p>T·ªïng Doanh Thu (Theo b·ªô l·ªçc)</p>
                    </div>
                </div>
                </div>

            <div class="panel" style="flex:1;">
                <div class="filter-bar-pro" style="margin-bottom: 0; border: none; padding: 0 0 20px 0; box-shadow: none; border-bottom: 1px solid var(--border-color); border-radius: 0;">
                    <select id="stats-type" class="form-control" style="width:160px" onchange="updateStatsInput()">
                        <option value="daily">üìÖ Theo Ng√†y</option>
                        <option value="monthly">üóìÔ∏è Theo Th√°ng</option>
                        <option value="yearly">üìÜ Theo NƒÉm</option>
                    </select>
                    <div id="stats-input-container" style="display:flex; gap:15px;">
                        <select id="stats-month" class="form-control" style="width:130px"></select>
                        <select id="stats-year" class="form-control" style="width:130px"></select>
                    </div>
                    <button class="btn-main" style="background: var(--text-heading); color: white; margin-left: auto; padding: 12px 25px;" onclick="loadStats()"><i class="fa-solid fa-filter"></i> L·ªçc d·ªØ li·ªáu</button>
                </div>
                <div class="chart-container-pro" style="flex:1; border: none; box-shadow: none; padding: 20px 0 0 0;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="print-area" style="display:none;">
    <div style="text-align:center; font-weight:bold; font-size: 24px; margin-bottom: 5px;">ƒê·∫∂NG NG√ÇN</div>
    <div style="text-align:center; font-size: 14px; margin-bottom: 15px;">ƒêc: Hi·ªáp ho√†</div>
    <div style="text-align:center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom:10px;">
        <h2 style="margin:0;">H√ìA ƒê∆†N </h2>
    </div>
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center; gap:12px;">
        <div style="display:flex; flex-direction:column; gap:6px;">
            <span id="print-invoice" style="font-weight:800;">M√£ h√≥a ƒë∆°n: -</span>
            <span id="print-table" style="font-weight:bold;">B√†n: ...</span>
        </div>
        <span id="print-date">...</span>
    </div>
    <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin-bottom: 15px;">
        <div id="print-items" style="line-height: 1.8; font-size: 16px;"></div>
    </div>
    <div style="text-align:right; font-size: 22px; font-weight:bold; margin-bottom:30px;">
        T·ªïng ti·ªÅn: <span id="print-total">...</span>
    </div>
    <p style="text-align:center; font-style: italic;">C·∫£m ∆°n qu√Ω kh√°ch & H·∫πn g·∫∑p l·∫°i!</p>
</div>

<div id="order-detail-modal" class="overlay-confirm" style="display:none; background:rgba(26,32,44,0.7);">
    <div class="modal-confirm" style="width:500px; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; font-size:1.4rem; color:var(--primary);">Chi ti·∫øt ƒë∆°n h√†ng</h3>
            <button onclick="closeOrderDetail()" style="background:none; border:none; font-size:1.4rem; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        
        <div style="background:#F8FAFC; padding:15px; border-radius:12px; margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="color:var(--text-muted); font-weight:600;">M√£ ƒë∆°n:</span>
                <span id="detail-order-id" style="font-weight:800; color:var(--primary);"></span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="color:var(--text-muted); font-weight:600;">Khu v·ª±c:</span>
                <span id="detail-table" style="font-weight:600;"></span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="color:var(--text-muted); font-weight:600;">Th·ªùi gian:</span>
                <span id="detail-time" style="font-weight:600;"></span>
            </div>
            <div style="display:flex; justify-content:space-between; padding-top:10px; border-top:1px solid var(--border-color);">
                <span style="color:var(--text-muted); font-weight:600;">T·ªïng ti·ªÅn:</span>
                <span id="detail-total" style="font-weight:900; font-size:1.2rem; color:var(--primary);"></span>
            </div>
        </div>
        
        <div style="margin-bottom:15px;">
            <h4 style="margin:0 0 12px 0; color:var(--text-heading); font-weight:700;">Chi ti·∫øt c√°c m√≥n:</h4>
            <div id="detail-items" style="background:#F8FAFC; border-radius:12px; max-height:300px; overflow-y:auto;"></div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="closeOrderDetail()" class="btn-main" style="flex:1; background:#EDF2F7; color:var(--text-body);"><i class="fa-solid fa-xmark"></i> ƒê√≥ng</button>
            <button onclick="printOrderDetail()" class="btn-main" style="flex:1; background:var(--accent-gradient); color:white;"><i class="fa-solid fa-print"></i> In</button>
        </div>
    </div>
</div>

<audio id="beep" src="/assets/audio/beep.mp3">"></audio>

<script>
    // --- SECURITY LOCK ---
    if (sessionStorage.getItem('is_verified') === 'true') {
        document.getElementById('security-lock').style.display = 'none';
    }
    function checkSecurity() {
        const p = document.getElementById('sec-pass').value;
        const err = document.getElementById('sec-error');
        if (p === '123456AZ') {
            document.getElementById('security-lock').style.display = 'none';
            sessionStorage.setItem('is_verified', 'true');
        } else {
            err.style.display = 'block';
            // Rung l·∫Øc nh·∫π h·ªôp nh·∫≠p li·ªáu ƒë·ªÉ b√°o l·ªói
            document.querySelector('.lock-box').style.animation = 'shake 0.3s';
            setTimeout(() => document.querySelector('.lock-box').style.animation = '', 300);
        }
    }
    // Th√™m animation rung l·∫Øc
    document.head.insertAdjacentHTML('beforeend', `<style>@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }</style>`);


    const socket = io();
    let products = [], cart = [], currentTable = null;
    let revenueChart = null; 
    let currentFilter = 'all';
    let totalTables = parseInt(localStorage.getItem('tableCount')) || 12;

    function showToast(msg, type='success') {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = 'toast';
        t.style.borderLeftColor = type === 'success' ? '#48BB78' : '#E53E3E';
        t.innerHTML = `<i class="fa-solid fa-${type==='success'?'circle-check':'circle-xmark'}" style="color:${type==='success'?'#48BB78':'#E53E3E'}; font-size: 1.2rem;"></i> <span>${msg}</span>`;
        container.appendChild(t);
        setTimeout(() => { t.style.animation = 'slideInRight 0.4s reverse forwards'; setTimeout(() => t.remove(), 400); }, 3000);
    }
    // Modal
    function showConfirm(msg, cb) {
        const m = document.getElementById('confirm-modal');
        m.querySelector('p').innerText = msg;
        m.style.display = 'flex';
        const btn = document.getElementById('btn-confirm-yes');
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener('click', () => { m.style.display = 'none'; cb(); });
    }
    function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; }

    window.onload = async () => {
        renderTables();
        await loadData();
        await syncBusyTables();
        initStatsControls();
    };

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // Highlight logic cho n√∫t b·∫•m
        const navs = document.querySelectorAll('.nav-item');
        if(id==='dashboard') navs[0].classList.add('active');
        else if(id==='menu') navs[3].classList.add('active'); // Index c√≥ th·ªÉ thay ƒë·ªïi t√πy s·ªë l∆∞·ª£ng item
        else if(id==='history') { navs[4].classList.add('active'); loadOrderHistory(); }
        else if(id==='stats') navs[5].classList.add('active');
        else if(id==='accounts') navs[2].classList.add('active'); // Tab Nh√¢n s·ª±
    }

    // --- DASHBOARD LOGIC ---
    function renderTables() {
        const div = document.getElementById('tables-ui');
        let html = `<button class="table-btn" id="t-0" onclick="selectTbl('0', true)"><i class="fa-solid fa-bag-shopping"></i><span>Mang V·ªÅ</span></button>`;
        for(let i=1; i<=totalTables; i++) html += `<button class="table-btn" id="t-${i}" onclick="selectTbl('${i}', false)"><i class="fa-solid fa-chair"></i><span>B√†n ${i}</span></button>`;
        html += `<button class="table-btn table-btn-add" onclick="addTable()"><i class="fa-solid fa-plus"></i><span>Th√™m</span></button>`;
        div.innerHTML = html;
    }
    function addTable() {
        totalTables++;
        localStorage.setItem('tableCount', totalTables);
        renderTables(); syncBusyTables();
        showToast(`ƒê√£ th√™m khu v·ª±c B√†n ${totalTables}`);
    }
    async function selectTbl(name, isTakeAway) {
        currentTable = { name, isTakeAway };

        // HI·ªÜN giao di·ªán ch·ªçn ƒë·ªì, ·∫®N th√¥ng b√°o nh·∫Øc nh·ªü
        document.getElementById('no-table-selected').style.display = 'none';
        document.getElementById('pos-menu-container').classList.add('active');

        // Highlight b√†n ƒë∆∞·ª£c ch·ªçn
        document.querySelectorAll('.table-btn').forEach(b => b.classList.remove('selected'));
        const btnId = name == '0' ? 't-0' : `t-${name}`;
        const targetBtn = document.getElementById(btnId);
        if(targetBtn) targetBtn.classList.add('selected');

        // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ gi·ªè h√†ng
        document.getElementById('pos-header').innerHTML = (name == '0') 
            ? `<i class="fa-solid fa-bag-shopping" style="margin-right:10px"></i> ƒê∆°n Mang V·ªÅ` 
            : `<i class="fa-solid fa-chair" style="margin-right:10px"></i> B√†n ${name}`;

        cart = [];
        try {
            const res = await fetch(`/api/orders/pending/${name}`);
            const o = await res.json();
            if(o && o.items) cart = o.items.map(i => ({ productName: i.productName, price: i.price, quantity: i.quantity }));
        } catch(e){}
        renderCart();
    }
    
    function updatePosItem(name, price, delta) {
        if(!currentTable) return showToast("Vui l√≤ng ch·ªçn b√†n tr∆∞·ªõc!", "error");
        socket.emit('send_order', { 
            tableNumber: currentTable.name, 
            items: [{ productName: name, price: price, quantity: delta }], 
            totalAmount: price * delta, 
            isTakeAway: currentTable.isTakeAway, 
            status: 'pending' 
        });
    }
    function addToCart(name, price) { updatePosItem(name, price, 1); }
    
    function renderCart() {
        let total = 0;
        const items = cart.filter(i => i.quantity > 0);
        document.getElementById('cart-list').innerHTML = items.map(i => {
            total += i.price * i.quantity;
            return `<div class="cart-item">
                <div class="cart-item-info" style="flex:1"><b>${i.productName}</b><br><small>${i.price.toLocaleString()}</small></div>
                <div class="qty-control-box">
                    <div class="btn-qty" onclick="updatePosItem('${i.productName}', ${i.price}, -1)"><i class="fa-solid fa-minus"></i></div>
                    <span class="qty-display">${i.quantity}</span>
                    <div class="btn-qty" onclick="updatePosItem('${i.productName}', ${i.price}, 1)"><i class="fa-solid fa-plus"></i></div>
                </div>
                <div class="btn-remove-cart" onclick="updatePosItem('${i.productName}', ${i.price}, -${i.quantity})"><i class="fa-solid fa-trash-can"></i></div>
                <div style="margin-left:15px; font-weight:800; font-size:1.1rem; color:var(--text-heading);">${(i.price*i.quantity).toLocaleString()}</div>
            </div>`;
        }).join('');
        document.getElementById('cart-total').innerText = total.toLocaleString() + 'ƒë';
    }
    
    function filterMenu(cat, el) { 
        currentFilter = cat; 
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        if(el) el.classList.add('active');
        renderPosMenu(); 
    }

    // --- HELPER: TI·∫æNG VI·ªÜT KH√îNG D·∫§U ---
    function removeVietnameseTones(str) {
        str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"); 
        str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"); 
        str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"); 
        str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"); 
        str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"); 
        str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"); 
        str = str.replace(/ƒë/g,"d");
        str = str.replace(/√Ä|√Å|·∫†|·∫¢|√É|√Ç|·∫¶|·∫§|·∫¨|·∫®|·∫™|ƒÇ|·∫∞|·∫Æ|·∫∂|·∫≤|·∫¥/g, "A");
        str = str.replace(/√à|√â|·∫∏|·∫∫|·∫º|√ä|·ªÄ|·∫æ|·ªÜ|·ªÇ|·ªÑ/g, "E");
        str = str.replace(/√å|√ç|·ªä|·ªà|ƒ®/g, "I");
        str = str.replace(/√í|√ì|·ªå|·ªé|√ï|√î|·ªí|·ªê|·ªò|·ªî|·ªñ|∆†|·ªú|·ªö|·ª¢|·ªû|·ª†/g, "O");
        str = str.replace(/√ô|√ö|·ª§|·ª¶|≈®|∆Ø|·ª™|·ª®|·ª∞|·ª¨|·ªÆ/g, "U");
        str = str.replace(/·ª≤|√ù|·ª¥|·ª∂|·ª∏/g, "Y");
        str = str.replace(/ƒê/g, "D");
        return str.toLowerCase();
    }

    // --- UPDATED SEARCH LOGIC ---
    function renderPosMenu() {
        const rawTerm = document.getElementById('pos-search').value.trim();
        const term = removeVietnameseTones(rawTerm);
        
        const f = products.filter(p => {
            const matchCat = (currentFilter === 'all' || p.category === currentFilter);
            const nameNoTone = removeVietnameseTones(p.name);
            return matchCat && nameNoTone.includes(term);
        });

        document.getElementById('pos-menu').innerHTML = f.map(p => `
            <div class="pos-item" onclick="addToCart('${p.name}', ${p.price})">
                <div class="pos-item-img-box">
                    <img class="pos-thumb" src="${p.image}" onerror="this.src='https://placehold.co/100x100/F3F5F9/A0AEC0?text=No+Image'" loading="lazy" alt="${p.name}">
                </div>
                <div class="pos-item-info">
                    <div class="pos-item-name" title="${p.name}">${p.name}</div>
                    <div class="pos-item-price">${p.price.toLocaleString()}ƒë</div>
                </div>
            </div>`).join('');
    }

    function renderFilterChips() {
        const map = {
            all: ['fa-layer-group', 'T·∫•t c·∫£'],
            Drink: ['fa-mug-saucer', 'N∆∞·ªõc'],
            Snack: ['fa-cookie-bite', 'ƒÇn v·∫∑t'],
            Grocery: ['fa-cart-shopping', 'T·∫°p h√≥a']
        };
        const container = document.getElementById('filter-chips');
        if(!container) return;

        const cats = Array.from(new Set(products.map(p => p.category).filter(Boolean)));
        let html = `<button class="filter-chip ${currentFilter==='all'?'active':''}" onclick="filterMenu('all', this)"><i class="fa-solid fa-layer-group"></i> T·∫•t c·∫£</button>`;
        cats.forEach(c => {
            const info = map[c] || ['fa-tag', c];
            const active = currentFilter === c ? 'active' : '';
            html += `<button class="filter-chip ${active}" onclick="filterMenu('${c}', this)"><i class="fa-solid ${info[0]}"></i> ${info[1]}</button>`;
        });
        container.innerHTML = html;
    }

    async function loadData() {
        const res = await fetch('/api/admin/products');
        products = await res.json();
        renderFilterChips();
        renderPosMenu(); renderAdminTable();
    }
    async function syncBusyTables() {
        const res = await fetch('/api/orders/pending-all');
        const o = await res.json();
        document.querySelectorAll('.table-btn').forEach(b => b.classList.remove('busy'));
        o.forEach(x => {
            const btn = document.getElementById(x.tableNumber == '0' ? 't-0' : `t-${x.tableNumber}`);
            if(btn) btn.classList.add('busy');
        });
    }

    // --- MENU TAB ---
    function renderAdminTable() {
        const rawTerm = document.getElementById('admin-search').value.trim();
        const term = removeVietnameseTones(rawTerm);
        
        const f = products.filter(p => {
            const nameNoTone = removeVietnameseTones(p.name);
            return nameNoTone.includes(term);
        });

        document.getElementById('menu-table').innerHTML = f.map(p => `
            <tr>
                <td><img src="${p.image}" style="width:45px; height:45px; border-radius:10px; object-fit:cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"></td>
                <td><b>${p.name}</b></td>
                <td style="font-weight:700; color:var(--primary)">${p.price.toLocaleString()}ƒë</td>
                <td><span class="badge badge-neutral"><i class="fa-solid fa-tag" style="margin-right:5px"></i> ${p.category}</span></td>
                <td><span class="badge ${p.isVisible?'badge-success':'badge-danger'}" onclick="toggle('${p._id}')" style="cursor:pointer"><i class="fa-solid fa-${p.isVisible?'eye':'eye-slash'}" style="margin-right:5px"></i> ${p.isVisible?'Hi·ªÉn th·ªã':'ƒêang ·∫©n'}</span></td>
                <td style="text-align:right">
                    <button class="action-btn btn-edit" onclick="editProduct('${p._id}')"><i class="fa-solid fa-pen-to-square"></i></button>
                    <button class="action-btn btn-delete" onclick="del('${p._id}')"><i class="fa-solid fa-trash-can"></i></button>
                </td>
            </tr>`).join('');
    }
    function editProduct(id) {
        const p = products.find(i=>i._id===id);
        if(p) {
            document.getElementById('edit-id').value = p._id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-category').value = p.category;
            // Show image preview for edit
            const img = document.getElementById('image-preview');
            img.src = p.image;
            img.classList.add('show');
            document.getElementById('file-upload-box').classList.add('has-image');
            showToast("ƒê√£ t·∫£i th√¥ng tin m√≥n ƒë·ªÉ s·ª≠a");
        }
    }
    function previewImage(event) {
        const file = event.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('image-preview');
                img.src = e.target.result;
                img.classList.add('show');
                document.getElementById('file-upload-box').classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }
    }
    function resetForm() { 
        document.getElementById('product-form').reset(); 
        document.getElementById('edit-id').value='';
        document.getElementById('image-preview').classList.remove('show');
        document.getElementById('file-upload-box').classList.remove('has-image');
    }
    async function toggle(id) { await fetch(`/api/products/toggle/${id}`, { method: 'POST' }); loadData(); showToast("ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!"); }
    async function del(id) { showConfirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a m√≥n n√†y kh·ªèi th·ª±c ƒë∆°n?", async ()=>{ await fetch(`/api/products/${id}`, { method: 'DELETE' }); loadData(); showToast("ƒê√£ x√≥a m√≥n th√†nh c√¥ng!"); }); }

    // --- HISTORY TAB ---
    let allOrders = [];
    async function loadOrderHistory() {
        try {
            const res = await fetch('/api/orders/history');
            allOrders = await res.json();
            const tbody = document.getElementById('history-table-body');
            if(allOrders.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 30px; color: var(--text-muted);"><i class="fa-solid fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i><br>Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë∆°n h√†ng n√†o.</td></tr>';
                 return;
            }
            tbody.innerHTML = allOrders.map((o, idx) => {
                const itemsStr = o.items.map(i => `${i.productName} (x${i.quantity})`).join(', ');
                const dateStr = new Date(o.createdAt).toLocaleString('vi-VN', { hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit' });
                const tableStr = o.tableNumber == '0' ? '<span class="badge badge-warning"><i class="fa-solid fa-bag-shopping"></i> Mang V·ªÅ</span>' : `<span class="badge badge-neutral"><i class="fa-solid fa-chair"></i> B√†n ${o.tableNumber}</span>`;
                const displayCode = o.invoiceCode ? o.invoiceCode : ('#' + o._id.slice(-6).toUpperCase());
                return `
                    <tr onclick="openOrderDetail(${idx})">
                        <td style="font-family:monospace; font-weight:700; color:var(--primary)">${displayCode}</td>
                        <td>${tableStr}</td>
                        <td style="font-size:0.9rem; font-weight:600;">${dateStr}</td>
                        <td style="max-width:250px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--text-body);" title="${itemsStr}">${itemsStr}</td>
                        <td style="font-weight:800; font-size:1rem; color:var(--text-heading)">${o.totalAmount.toLocaleString()}ƒë</td>
                        <td><span class="badge badge-success"><i class="fa-solid fa-check-circle"></i> ƒê√£ thanh to√°n</span></td>
                    </tr>
                `;
            }).join('');
        } catch(e) { console.error("L·ªói t·∫£i l·ªãch s·ª≠:", e); showToast("Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠ ƒë∆°n", "error"); }
    }
    
    function openOrderDetail(idx) {
        const o = allOrders[idx];
        if(!o) return;
        
        // Show full invoice/order id so it prints completely
        document.getElementById('detail-order-id').innerText = '#' + o._id.toUpperCase();
        document.getElementById('detail-table').innerText = o.tableNumber == '0' ? 'Mang V·ªÅ' : 'B√†n ' + o.tableNumber;
        document.getElementById('detail-time').innerText = new Date(o.createdAt).toLocaleString('vi-VN', { hour: '2-digit', minute:'2-digit', second:'2-digit', day:'2-digit', month:'2-digit', year:'numeric' });
        document.getElementById('detail-total').innerText = o.totalAmount.toLocaleString() + 'ƒë';
        
        const itemsHtml = o.items.map(i => {
            const prod = products.find(p => p.name === i.productName) || {};
            const img = prod.image ? prod.image : 'https://placehold.co/100x100/F3F5F9/A0AEC0?text=No+Image';
            return `
            <div class="detail-item-row">
                <div class="detail-item-left">
                    <img class="detail-thumb" src="${img}" onerror="this.src='https://placehold.co/100x100/F3F5F9/A0AEC0?text=No+Image'">
                    <div>
                        <div style="font-weight:700; color:var(--text-heading);">${i.productName}</div>
                        <div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">ƒê∆°n gi√°: ${i.price.toLocaleString()}ƒë</div>
                    </div>
                </div>
                <div style="text-align:right; min-width:110px;">
                    <div style="font-weight:700; background:var(--primary-light-bg); color:var(--primary); padding:4px 10px; border-radius:6px; font-size:0.9rem;">x${i.quantity}</div>
                    <div style="margin-top:6px; font-weight:800; color:var(--text-heading);">${(i.price * i.quantity).toLocaleString()}ƒë</div>
                </div>
            </div>`;
        }).join('');
        document.getElementById('detail-items').innerHTML = itemsHtml;
        
        document.getElementById('order-detail-modal').style.display = 'flex';
    }
    
    function closeOrderDetail() {
        document.getElementById('order-detail-modal').style.display = 'none';
    }
    
    function printOrderDetail() {
        const modal = document.getElementById('order-detail-modal');
        const printContent = modal.innerHTML;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Chi ti·∫øt ƒë∆°n h√†ng</title>');
        printWindow.document.write('<style>body { font-family: Arial, "Segoe UI", sans-serif; padding: 20px; } .detail-thumb{ width:64px; height:64px; object-fit:cover; border-radius:8px; box-shadow:0 6px 14px rgba(0,0,0,0.06);} .detail-item-row{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 0;border-bottom:1px dashed #E6EEF8;} .detail-item-left{display:flex;align-items:center;gap:10px;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(printContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        setTimeout(() => printWindow.print(), 500);
    }

    // --- STATS TAB ---
    function initStatsControls() {
        const d = new Date();
        const m = document.getElementById('stats-month'); for(let i=1;i<=12;i++) m.innerHTML+=`<option value="${i}" ${i===d.getMonth()+1?'selected':''}>Th√°ng ${i}</option>`;
        const y = document.getElementById('stats-year'); for(let i=2024;i<=d.getFullYear()+1;i++) y.innerHTML+=`<option value="${i}" ${i===d.getFullYear()?'selected':''}>NƒÉm ${i}</option>`;
        updateStatsInput();
    }
    function updateStatsInput() { document.getElementById('stats-month').style.display = document.getElementById('stats-type').value==='daily'?'block':'none'; }
    async function loadStats() {
        const t = document.getElementById('stats-type').value;
        const m = document.getElementById('stats-month').value;
        const y = document.getElementById('stats-year').value;
        const res = await fetch(`/api/stats/revenue?type=${t}&month=${m}&year=${y}`);
        const data = await res.json();
        if(revenueChart) revenueChart.destroy();
        
        // T·∫°o gradient cho bi·ªÉu ƒë·ªì
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(255, 107, 107, 0.8)');
        gradient.addColorStop(1, 'rgba(255, 142, 83, 0.2)');

        revenueChart = new Chart(ctx, { 
            type: 'line', // ƒê·ªïi sang bi·ªÉu ƒë·ªì ƒë∆∞·ªùng cho ƒë·∫πp h∆°n
            data: { 
                labels: data.map(i=>i._id), 
                datasets: [{ 
                    label: 'Doanh thu (VNƒê)', 
                    data: data.map(i=>i.total), 
                    backgroundColor: gradient,
                    borderColor: '#FF6B6B',
                    borderWidth: 3,
                    pointBackgroundColor: 'white',
                    pointBorderColor: '#FF6B6B',
                    pointBorderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    fill: true,
                    tension: 0.4 // ƒê∆∞·ªùng cong m·ªÅm m·∫°i
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#E2E8F0', borderDash: [5, 5] } },
                    x: { grid: { display: false } }
                }
            } 
        });
        document.getElementById('stats-total').innerText = data.reduce((a,b)=>a+b.total,0).toLocaleString() + 'ƒë';
    }

    // --- CHECKOUT ---
    function resetToInitialState() {
        currentTable = null;
        cart = [];
        document.getElementById('no-table-selected').style.display = 'flex';
        document.getElementById('pos-menu-container').classList.remove('active');
        document.getElementById('pos-header').innerHTML = `<i class="fa-solid fa-circle-info" style="margin-right: 10px;"></i> Ch∆∞a ch·ªçn b√†n`;
        document.querySelectorAll('.table-btn').forEach(b => b.classList.remove('selected'));
        renderCart();
    }

    function checkout() {
        if(!currentTable || cart.length === 0) return showToast("Vui l√≤ng ch·ªçn b√†n v√† m√≥n!", "error");
        // Generate a short invoice code in hex style (e.g. #C1F743) to match history list
        const invoiceCode = ('#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).toUpperCase().padStart(6, '0'));
        document.getElementById('print-invoice').innerText = 'M√£ h√≥a ƒë∆°n: ' + invoiceCode;
        document.getElementById('print-table').innerText = currentTable.name == '0' ? 'Mang V·ªÅ' : `B√†n ${currentTable.name}`;
        document.getElementById('print-date').innerText = new Date().toLocaleString('vi-VN');
        document.getElementById('print-total').innerText = document.getElementById('cart-total').innerText;
        document.getElementById('print-items').innerHTML = cart.filter(i=>i.quantity>0).map(i=>{
            const prod = products.find(p => p.name === i.productName) || {};
            const img = prod.image ? prod.image : 'https://placehold.co/100x100/F3F5F9/A0AEC0?text=No+Image';
            return `
                <div class="print-item-row">
                    <div class="print-item-left">
                        <img class="print-thumb" src="${img}" onerror="this.src='https://placehold.co/100x100/F3F5F9/A0AEC0?text=No+Image'">
                        <div style="line-height:1.1">
                            <div style="font-weight:700">${i.productName}</div>
                            <div style="font-size:0.9rem; color:#667085">ƒê∆°n gi√°: ${i.price.toLocaleString()}ƒë √ó ${i.quantity}</div>
                        </div>
                    </div>
                    <div style="font-weight:800">${(i.price*i.quantity).toLocaleString()}ƒë</div>
                </div>`;
        }).join('');
        // send invoiceCode to server so saved order can include the same code
        const notes = document.getElementById('admin-notes').value.trim();
        socket.emit('pay_order', { tableNumber: currentTable.name, invoiceCode, notes });
        showToast("Thanh to√°n th√†nh c√¥ng! ƒêang in h√≥a ƒë∆°n...");
        setTimeout(() => window.print(), 800);
        
        // Reset giao di·ªán sau khi thanh to√°n
        resetToInitialState();
    }

    // --- B·ªî SUNG: H√ÄM T·∫†O T√ÄI KHO·∫¢N ---
    async function createAccount(event) {
        event.preventDefault();
        
        const username = document.getElementById('new-username').value.trim();
        const password = document.getElementById('new-password').value;
        const fullName = document.getElementById('new-fullname').value.trim();
        const role = document.getElementById('new-role').value;

        try {
            const res = await fetch('/api/admin/create-account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, fullName, role })
            });
            
            const data = await res.json();
            
            if (data.success) {
                showToast("‚úÖ ƒê√£ t·∫°o t√†i kho·∫£n th√†nh c√¥ng!");
                document.getElementById('create-account-form').reset();
            } else {
                showToast(data.message || "‚ùå L·ªói: T√™n t√†i kho·∫£n ƒë√£ t·ªìn t·∫°i!", "error");
            }
        } catch (err) {
            showToast("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!", "error");
        }
    }

    // --- SOCKET ---
    socket.on('new_order_to_admin', (order) => {
        document.getElementById('beep').play();
        
        // Logic hi·ªÉn th·ªã card ƒë∆°n h√†ng ƒê√É B·ªä LO·∫†I B·ªé theo y√™u c·∫ßu.
        // Ch·ªâ gi·ªØ l·∫°i logic c·∫≠p nh·∫≠t tr·∫°ng th√°i b√†n b·∫≠n (m√†u v√†ng)
        const hasItems = order.items && order.items.some(i => i.quantity > 0);
        const btn = document.getElementById(order.tableNumber == '0' ? 't-0' : `t-${order.tableNumber}`);
        
        if(order.status === 'deleted' || !hasItems) { 
            if(btn) btn.classList.remove('busy'); 
        }
        else if(order.status === 'pending') { 
            if(btn) btn.classList.add('busy'); 
        }

        // N·∫øu ƒëang m·ªü ƒë√∫ng b√†n n√†y th√¨ c·∫≠p nh·∫≠t gi·ªè h√†ng realtime
        if(currentTable && currentTable.name == order.tableNumber) {
            cart = order.items.map(i => ({ productName: i.productName, price: i.price, quantity: i.quantity }));
            renderCart();
        }
        // N·∫øu ƒëang ·ªü tab l·ªãch s·ª≠, reload l·∫°i ƒë·ªÉ th·∫•y ƒë∆°n m·ªõi nh·∫•t n·∫øu n√≥ v·ª´a ƒë∆∞·ª£c thanh to√°n
        if(document.getElementById('history').classList.contains('active') && order.status === 'paid') {
            loadOrderHistory();
        }
    });

    socket.on('order_paid_success', (order) => {
        const btn = document.getElementById(order.tableNumber == '0' ? 't-0' : `t-${order.tableNumber}`);
        if(btn) btn.classList.remove('busy');
        
        // N·∫øu ƒëang xem b√†n v·ª´a thanh to√°n th√¨ reset
        if(currentTable && currentTable.name == order.tableNumber) { 
            resetToInitialState();
        }
        
        // Reload l·ªãch s·ª≠ n·∫øu ƒëang xem
        if(document.getElementById('history').classList.contains('active')) {
            loadOrderHistory();
        }
    });
</script>
</body>
</html>