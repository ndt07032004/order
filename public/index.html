<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ƒê·∫∂NG NG√ÇN - Menu</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff6600;
            --primary-light: #ff8c42;
            --accent: #ff4b4b;
            --bg-1: #0a0e1a;
            --bg-2: #0f1628;
            --card: #ffffff;
            --text-dark: #0b1220;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 8px 16px rgba(0,0,0,0.1);
            --shadow-lg: 0 16px 32px rgba(0,0,0,0.15);
        }

        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #060812 0%, #0a0e1a 40%, #0f1628 100%);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(10,14,26,0.95) 0%, rgba(15,22,40,0.88) 100%);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 800;
            font-size: 1.15rem;
            background: linear-gradient(90deg, #ff6600, #ff8c42);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge-table {
            background: linear-gradient(135deg, #ff6600 0%, #ff8c42 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 102, 0, 0.2);
        }

        .btn-login-nav {
            text-decoration: none;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.08);
            padding: 6px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.1rem;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-login-nav:hover {
            background: rgba(255, 102, 0, 0.12);
            border-color: rgba(255, 102, 0, 0.3);
            color: #ff6600;
        }

        /* Order status bar */
        #order-status-bar {
            background: linear-gradient(90deg, rgba(255, 165, 0, 0.1), rgba(255, 102, 0, 0.05));
            border-bottom: 1px solid rgba(255, 102, 0, 0.2);
            color: #ff9e42;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            display: none;
            position: sticky;
            top: 56px;
            z-index: 99;
            animation: slideDown 0.3s ease-out;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ff6600;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Category chips */
        .category-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 16px 16px 8px 16px;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }

        .category-scroll::-webkit-scrollbar {
            display: none;
        }

        .cat-chip {
            background: rgba(255, 255, 255, 0.06);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.08);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cat-chip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .cat-chip.active {
            background: linear-gradient(135deg, #ff6600, #ff8c42);
            color: white;
            border-color: #ff6600;
            box-shadow: 0 4px 12px rgba(255, 102, 0, 0.2);
        }

        /* Product grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 14px;
            padding: 16px;
        }

        @media (max-width: 480px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 12px;
            }
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            border: 1px solid #f0f4f8;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .card:active {
            transform: scale(0.96);
            box-shadow: var(--shadow-sm);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-img-box {
            width: 100%;
            height: 140px;
            background: #f1f5f9;
            overflow: hidden;
            position: relative;
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .card-body {
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-dark);
            margin-bottom: 6px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-price {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.05rem;
            margin-top: auto;
            margin-bottom: 8px;
        }

        .btn-add {
            background: linear-gradient(135deg, #fff5f0, #ffebdd);
            color: var(--primary);
            border: none;
            padding: 8px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-add:active {
            transform: scale(0.95);
        }

        /* Toast */
        #toast-box {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            width: 92%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(20, 20, 30, 0.96);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInTop 0.28s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .toast.success {
            border-left: 3px solid #00c853;
        }

        /* Cart bar */
        .cart-bar {
            position: fixed;
            left: 16px;
            right: 16px;
            bottom: 16px;
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.96), rgba(30, 30, 45, 0.94));
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 16px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cart-bar.show {
            transform: translateY(0);
        }

        .cart-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .btn-view-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 102, 0, 0.2);
            transition: all 0.2s ease;
        }

        .btn-view-cart:active {
            transform: scale(0.95);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: flex-end;
        }

        .cart-modal {
            background: white;
            width: 100%;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            animation: slideUpSheet 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-dark);
        }

        .cart-modal h3 {
            margin: 0 0 20px 0;
            font-size: 1.2rem;
            font-weight: 800;
        }

        .cart-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #eef2f7;
        }

        .btn-qty {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }

        .btn-qty:active {
            transform: scale(0.95);
        }

        .btn-order-confirm {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-weight: 800;
            border: none;
            margin-top: 20px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 102, 0, 0.15);
            transition: all 0.28s ease;
        }

        .btn-order-confirm:active {
            transform: scale(0.98);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideInTop {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideUpSheet {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header {
                padding: 10px 14px;
            }

            .logo {
                font-size: 1rem;
            }

            .badge-table {
                font-size: 0.8rem;
                padding: 5px 12px;
            }

            .category-scroll {
                padding: 12px 12px 6px 12px;
            }

            .cart-modal {
                border-radius: 20px 20px 0 0;
                padding: 18px;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">ƒê·∫∂NG NG√ÇN </div>
        
        <div class="header-right">
            <div id="table-title" class="badge-table">B√†n ...</div>
            <a href="/login.html" class="btn-login-nav">üîë</a>
        </div>
    </div>

    <div id="order-status-bar">
        <span class="status-dot"></span> ‚è≥ ƒê∆°n h√†ng ƒë√£ g·ª≠i & ƒëang ch·ªù x·ª≠ l√Ω...
    </div>

    <div class="category-scroll">
        <div class="cat-chip active" onclick="filter('all', this)">T·∫•t c·∫£</div>
        <div class="cat-chip" onclick="filter('Drink', this)">‚òï ƒê·ªì u·ªëng</div>
        <div class="cat-chip" onclick="filter('Snack', this)">üç∞ ƒÇn v·∫∑t</div>
    </div>

    <div id="menu" class="grid"></div>

    <div id="toast-box"></div>

    <div id="cart-ui" class="cart-bar" onclick="toggleCart()">
        <div class="cart-info">
            <span id="cart-count" style="font-size: 0.8rem; opacity: 0.7;">0 m√≥n</span>
            <span id="cart-total" style="font-weight: 700; font-size: 1.1rem;">0ƒë</span>
        </div>
        <div class="btn-view-cart">Gi·ªè h√†ng üõí</div>
    </div>

    <div id="cart-modal" class="modal-overlay">
        <div class="cart-modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0">Gi·ªè h√†ng c·ªßa b·∫°n</h3>
                <div onclick="toggleCart()" style="padding:10px; font-size:1.5rem;">‚úï</div>
            </div>
            <div id="cart-items-list" style="overflow-y:auto; flex:1;"></div>
            <div style="margin-top:auto">
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:700; margin-bottom:10px;">
                    <span>T·ªïng:</span> <span id="modal-total" style="color:var(--primary)">0ƒë</span>
                </div>
                <button class="btn-order-confirm" onclick="sendOrder()">X√ÅC NH·∫¨N G·ªåI M√ìN</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const params = new URLSearchParams(window.location.search);
        
        // [C·∫¨P NH·∫¨T] Logic hi·ªÉn th·ªã t√™n b√†n (H·ªó tr·ª£ Mang V·ªÅ = B√†n 0)
        const table = params.get('table') || '0'; 
        const displayTable = (table === '0') ? 'Qu·∫ßy' : `B√†n ${table}`;
        document.getElementById('table-title').innerText = displayTable;

        let cart = [];
        let allProducts = [];

        // Check tr·∫°ng th√°i ƒë∆°n pending
        if (localStorage.getItem(`status_${table}`) === 'pending') {
            document.getElementById('order-status-bar').style.display = 'block';
        }

        // --- FETCH S·∫¢N PH·∫®M ---
        fetch('/api/products').then(r => r.json()).then(products => {
            allProducts = products;
            renderMenu(products);
        });

        function renderMenu(list) {
            document.getElementById('menu').innerHTML = list.map(p => `
                <div class="card" onclick="updateQuantity('${p.name}', ${p.price}, 1)">
                    <div class="card-img-box"><img src="${p.image}" class="card-img" onerror="this.src='https://placehold.co/300x200?text=IMG'"></div>
                    <div class="card-body">
                        <div class="card-title">${p.name}</div>
                        <div class="card-price">${p.price.toLocaleString()}ƒë</div>
                        <button class="btn-add">Th√™m +</button>
                    </div>
                </div>
            `).join('');
        }

        function filter(cat, el) {
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderMenu(cat === 'all' ? allProducts : allProducts.filter(p => p.category === cat));
        }

        // --- CART LOGIC ---
        function updateQuantity(name, price, change) {
            const idx = cart.findIndex(i => i.productName === name);
            if (idx > -1) {
                cart[idx].quantity += change;
                if (cart[idx].quantity <= 0) cart.splice(idx, 1);
            } else if (change > 0) {
                cart.push({ productName: name, price: price, quantity: 1 });
                showToast(`ƒê√£ th√™m ${name}`, 'success');
            }
            updateCartUI();
        }

        function updateCartUI() {
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            
            const bar = document.getElementById('cart-ui');
            if(count > 0) bar.classList.add('show');
            else {
                bar.classList.remove('show');
                document.getElementById('cart-modal').style.display = 'none';
            }

            document.getElementById('cart-count').innerText = `${count} m√≥n`;
            document.getElementById('cart-total').innerText = total.toLocaleString() + 'ƒë';
            document.getElementById('modal-total').innerText = total.toLocaleString() + 'ƒë';

            document.getElementById('cart-items-list').innerHTML = cart.map(i => `
                <div class="cart-item-row">
                    <div><div style="font-weight:700">${i.productName}</div><div style="font-size:0.9rem; color:#888">${i.price.toLocaleString()}</div></div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="btn-qty" onclick="updateQuantity('${i.productName}', ${i.price}, -1)">-</div>
                        <div style="font-weight:700; width:20px; text-align:center;">${i.quantity}</div>
                        <div class="btn-qty" onclick="updateQuantity('${i.productName}', ${i.price}, 1)">+</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }
        document.getElementById('cart-modal').addEventListener('click', (e) => { if(e.target.id === 'cart-modal') toggleCart(); });

        function showToast(msg, type) {
            const box = document.getElementById('toast-box');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>‚úÖ</span> <span>${msg}</span>`;
            box.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 2000);
        }

        // --- G·ª¨I ƒê∆†N & X·ª¨ L√ù TR·∫†NG TH√ÅI ---
        function sendOrder() {
            if(cart.length === 0) return;
            
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            
            // G·ª≠i l√™n server
            socket.emit('send_order', { 
                tableNumber: table, 
                items: cart, 
                totalAmount: total, 
                isTakeAway: (table === '0') // N·∫øu table l√† "0" th√¨ ƒë√°nh d·∫•u l√† Mang v·ªÅ
            });

            // 1. Reset Gi·ªè h√†ng
            cart = []; 
            updateCartUI();
            toggleCart(); 

            // 2. Hi·ªán Toast & Thanh tr·∫°ng th√°i
            showToast('ƒê√£ g·ª≠i ƒë∆°n th√†nh c√¥ng! Vui l√≤ng ch·ªù.', 'success');
            document.getElementById('order-status-bar').style.display = 'block';
            
            // L∆∞u tr·∫°ng th√°i v√†o LocalStorage ƒë·ªÉ F5 kh√¥ng m·∫•t
            localStorage.setItem(`status_${table}`, 'pending');
        }

        // --- L·∫ÆNG NGHE S·ª∞ KI·ªÜN THANH TO√ÅN ---
        socket.on('order_paid_success', (order) => {
            // Ki·ªÉm tra xem ƒë∆°n ƒë∆∞·ª£c thanh to√°n c√≥ ph·∫£i c·ªßa b√†n m√¨nh kh√¥ng
            // L∆∞u √Ω: table v√† order.tableNumber c√≥ th·ªÉ l√† string ho·∫∑c number, so s√°nh == l√† an to√†n nh·∫•t
            if (order.tableNumber == table) {
                // 1. ·∫®n thanh tr·∫°ng th√°i
                document.getElementById('order-status-bar').style.display = 'none';
                
                // 2. X√≥a tr·∫°ng th√°i l∆∞u tr·ªØ
                localStorage.removeItem(`status_${table}`);
                
                // 3. Hi·ªán th√¥ng b√°o c·∫£m ∆°n
                showToast('‚úÖ ƒê∆°n h√†ng ƒë√£ thanh to√°n xong. C·∫£m ∆°n qu√Ω kh√°ch!', 'success');
                
                // 4. Rung ƒëi·ªán tho·∫°i b√°o hi·ªáu
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
        });
    </script>
</body>
</html>