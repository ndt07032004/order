<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Menu</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette Tr·∫ª trung - S√°ng */
            --primary: #FF6B6B; /* H·ªìng cam ch·ªß ƒë·∫°o */
            --bg-body: #F4F7FE;
            --card-bg: #FFFFFF;
            --text-dark: #2D3436;
            --text-sub: #636E72;
            --success: #00B894;
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            background: var(--bg-body);
            padding-bottom: 100px; 
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent; 
            min-height: 100vh;
        }
        
        /* Header */
        .header { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            padding: 15px 20px; 
            position: sticky; top: 0; z-index: 100; 
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); letter-spacing: -0.5px; text-transform: uppercase; }
        .badge-table { 
            background: var(--text-dark); color: white; padding: 6px 14px; border-radius: 20px; 
            font-size: 0.8rem; font-weight: 700;
        }

        /* Thanh tr·∫°ng th√°i ƒë∆°n */
        #order-status-bar {
            background: #FFF3CD; border-bottom: 1px solid #FFD54F;
            color: #D35400; padding: 10px 20px; font-size: 0.9rem; font-weight: 600;
            display: none; animation: slideDown 0.3s; position: sticky; top: 60px; z-index: 99;
        }
        .status-dot { display: inline-block; width: 8px; height: 8px; background: #D35400; border-radius: 50%; margin-right: 8px; animation: pulse 1.5s infinite; }

        /* Category */
        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 15px 20px 5px 20px; scrollbar-width: none; }
        .cat-chip { 
            background: white; color: var(--text-sub); padding: 8px 18px; border-radius: 30px; 
            font-size: 0.9rem; border: 1px solid #eee; transition: 0.3s; white-space: nowrap; font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3); }

        /* Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .card { 
            background: var(--card-bg); border-radius: var(--radius); overflow: hidden; 
            box-shadow: var(--shadow); display: flex; flex-direction: column; 
            transition: transform 0.2s; border: 1px solid white;
        }
        .card:active { transform: scale(0.98); }
        .card img { width: 100%; height: 140px; object-fit: cover; }
        .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-weight: 700; font-size: 0.95rem; color: var(--text-dark); margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; }
        .card-price { color: var(--primary); font-weight: 800; font-size: 1rem; margin-top: auto; }
        
        .btn-add { 
            background: #FFF0F0; color: var(--primary); border: none; padding: 10px; 
            border-radius: 12px; margin-top: 10px; font-weight: 700; cursor: pointer; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        /* Cart Bar */
        .cart-bar { 
            position: fixed; bottom: 25px; left: 20px; right: 20px; 
            background: var(--text-dark); color: white; 
            padding: 14px 24px; border-radius: 50px; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 1000; 
            transform: translateY(150%); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cart-bar.show { transform: translateY(0); }
        .btn-view-cart { background: var(--primary); color: white; padding: 8px 18px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: flex-end; }
        .cart-modal { background: #fff; width: 100%; border-radius: 24px 24px 0 0; padding: 25px; max-height: 80vh; display: flex; flex-direction: column; animation: slideUpSheet 0.3s; }
        .cart-item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed #eee; }
        .btn-qty { width: 32px; height: 32px; border-radius: 50%; background: #F3F5F9; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.1rem; }
        .btn-order-confirm { background: var(--primary); color: white; width: 100%; padding: 18px; border-radius: 16px; font-weight: 800; border: none; margin-top: 20px; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3); }

        /* Toast */
        #toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 14px 20px; border-radius: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideInTop 0.3s; border-left: 5px solid var(--success); font-weight: 600; font-size: 0.95rem; }

        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes slideInTop { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">ƒê·∫∂NG NG√ÇN</div>
        <div id="table-title" class="badge-table">B√†n ...</div>
    </div>

    <div id="order-status-bar">
        <span class="status-dot"></span> ‚è≥ ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c chu·∫©n b·ªã...
    </div>

    <div class="category-scroll">
        <div class="cat-chip active" onclick="filter('all', this)">T·∫•t c·∫£</div>
        <div class="cat-chip" onclick="filter('Drink', this)">‚òï ƒê·ªì u·ªëng</div>
        <div class="cat-chip" onclick="filter('Snack', this)">üç∞ ƒÇn v·∫∑t</div>
    </div>

    <div id="menu" class="grid"></div>
    <div id="toast-box"></div>

    <div id="cart-ui" class="cart-bar" onclick="toggleCart()">
        <div class="cart-info">
            <span id="cart-count" style="font-size: 0.8rem; opacity: 0.7;">0 m√≥n</span>
            <span id="cart-total" style="font-weight: 800; font-size: 1.2rem;">0ƒë</span>
        </div>
        <div class="btn-view-cart">Gi·ªè h√†ng üõí</div>
    </div>

    <div id="cart-modal" class="modal-overlay">
        <div class="cart-modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; font-size:1.4rem; font-weight:800;">Gi·ªè h√†ng</h3>
                <div onclick="toggleCart()" style="padding:10px; font-size:1.5rem; color:#aaa;">‚úï</div>
            </div>
            <div id="cart-items-list" style="overflow-y:auto; flex:1;"></div>
            <div style="margin-top:auto">
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:700; margin-bottom:10px;">
                    <span>T·ªïng:</span> <span id="modal-total" style="color:var(--primary)">0ƒë</span>
                </div>
                <button class="btn-order-confirm" onclick="sendOrder()">G·ª¨I ƒê∆†N NGAY üöÄ</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const params = new URLSearchParams(window.location.search);
        const table = params.get('table') || 'Mang V·ªÅ';
        document.getElementById('table-title').innerText = table === 'Mang V·ªÅ' ? 'Mang V·ªÅ' : `B√†n ${table}`;

        let cart = [];
        let allProducts = [];

        // Check tr·∫°ng th√°i local
        if (localStorage.getItem(`status_${table}`) === 'pending') {
            document.getElementById('order-status-bar').style.display = 'block';
        }

        fetch('/api/products').then(r => r.json()).then(products => {
            allProducts = products;
            renderMenu(products);
        });

        function renderMenu(list) {
            document.getElementById('menu').innerHTML = list.map(p => `
                <div class="card" onclick="updateQuantity('${p.name}', ${p.price}, 1)">
                    <div class="card-img-box"><img src="${p.image}" class="card-img" onerror="this.src='https://placehold.co/300x300/F0F2F5/B2BEC3?text=IMG'"></div>
                    <div class="card-body">
                        <div class="card-title">${p.name}</div>
                        <div class="card-price">${p.price.toLocaleString()}ƒë</div>
                        <button class="btn-add">Th√™m +</button>
                    </div>
                </div>
            `).join('');
        }

        function filter(cat, el) {
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderMenu(cat === 'all' ? allProducts : allProducts.filter(p => p.category === cat));
        }

        function updateQuantity(name, price, change) {
            const idx = cart.findIndex(i => i.productName === name);
            if (idx > -1) {
                cart[idx].quantity += change;
                if (cart[idx].quantity <= 0) cart.splice(idx, 1);
            } else if (change > 0) {
                cart.push({ productName: name, price: price, quantity: 1 });
                showToast(`ƒê√£ th√™m ${name}`);
            }
            updateCartUI();
        }

        function updateCartUI() {
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            
            const bar = document.getElementById('cart-ui');
            if(count > 0) bar.classList.add('show');
            else {
                bar.classList.remove('show');
                document.getElementById('cart-modal').style.display = 'none';
            }

            document.getElementById('cart-count').innerText = `${count} m√≥n`;
            document.getElementById('cart-total').innerText = total.toLocaleString() + 'ƒë';
            document.getElementById('modal-total').innerText = total.toLocaleString() + 'ƒë';

            document.getElementById('cart-items-list').innerHTML = cart.map(i => `
                <div class="cart-item-row">
                    <div><div style="font-weight:700">${i.productName}</div><div style="font-size:0.9rem; color:#888">${i.price.toLocaleString()}</div></div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="btn-qty" onclick="updateQuantity('${i.productName}', ${i.price}, -1)">-</div>
                        <div style="font-weight:700; width:20px; text-align:center;">${i.quantity}</div>
                        <div class="btn-qty" onclick="updateQuantity('${i.productName}', ${i.price}, 1)">+</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }
        document.getElementById('cart-modal').addEventListener('click', (e) => { if(e.target.id === 'cart-modal') toggleCart(); });

        function showToast(msg) {
            const box = document.getElementById('toast-box');
            const toast = document.createElement('div');
            toast.className = `toast`;
            toast.innerHTML = `<span>‚úÖ</span> <span>${msg}</span>`;
            box.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 2000);
        }

        function sendOrder() {
            if(cart.length === 0) return;
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            socket.emit('send_order', { tableNumber: table, items: cart, totalAmount: total, isTakeAway: false });
            cart = []; updateCartUI(); toggleCart(); 
            showToast('G·ª≠i ƒë∆°n th√†nh c√¥ng!');
            document.getElementById('order-status-bar').style.display = 'block';
            localStorage.setItem(`status_${table}`, 'pending');
        }

        socket.on('order_paid_success', (order) => {
            if (order.tableNumber == table) {
                document.getElementById('order-status-bar').style.display = 'none';
                localStorage.removeItem(`status_${table}`);
                showToast('ƒê∆°n h√†ng ƒë√£ thanh to√°n xong. C·∫£m ∆°n!');
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
        });
    </script>
</body>
</html>