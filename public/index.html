<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Menu </title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff6600;
            --dark-bg: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-dark: #1e293b;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --success: #00c853;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            padding-bottom: 100px; 
            color: white;
            -webkit-tap-highlight-color: transparent; 
            min-height: 100vh;
        }
        
        /* --- HEADER (ƒê√£ c·∫≠p nh·∫≠t) --- */
        .header { 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(12px);
            padding: 15px 20px; 
            position: sticky; top: 0; z-index: 100; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid var(--glass-border);
        }
        .header h2 { margin: 0; font-size: 1.1rem; color: white; letter-spacing: 0.5px; }
        
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); letter-spacing: -0.5px; text-transform: uppercase; }

        /* Nh√≥m b√™n ph·∫£i (B√†n + Login) */
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa badge b√†n v√† n√∫t login */
        }

        .badge-table { 
            background: linear-gradient(45deg, #ff6600, #ff8c00); 
            color: white; padding: 6px 14px; border-radius: 20px; 
            font-size: 0.8rem; font-weight: 700; box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
        }

        /* N√∫t Login m·ªõi */
        .btn-login-nav {
            text-decoration: none;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-login-nav:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Thanh tr·∫°ng th√°i ƒë∆°n h√†ng */
        #order-status-bar {
            background: rgba(255, 165, 0, 0.2);
            border-bottom: 1px solid #ff6600;
            color: #ff9e42;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            animation: slideDown 0.3s;
            position: sticky;
            top: 60px; /* Ngay d∆∞·ªõi header */
            z-index: 99;
            backdrop-filter: blur(5px);
        }
        .status-dot {
            display: inline-block; width: 8px; height: 8px; background: #ff6600;
            border-radius: 50%; margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        /* Grid & Cards */
        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 15px 20px 5px 20px; scrollbar-width: none; }
        .cat-chip { background: rgba(255,255,255,0.1); color: #ccc; padding: 8px 16px; border-radius: 30px; font-size: 0.85rem; border: 1px solid transparent; transition: 0.3s; white-space: nowrap; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .card { 
            background: var(--card-bg); border-radius: 16px; overflow: hidden; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; 
            transition: transform 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .card:active { transform: scale(0.98); }
        .card img { width: 100%; height: 130px; object-fit: cover; }
        .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-weight: 700; font-size: 0.95rem; color: var(--text-dark); margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-price { color: var(--primary); font-weight: 800; font-size: 1rem; margin-top: auto; }
        
        .btn-add { 
            background: #fff0e6; color: var(--primary); border: none; padding: 8px; 
            border-radius: 10px; margin-top: 10px; font-weight: 700; cursor: pointer; width: 100%;
        }

        /* Cart & Modal */
        .cart-bar { 
            position: fixed; bottom: 25px; left: 20px; right: 20px; 
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); color: white; 
            padding: 12px 20px; border-radius: 50px; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; 
            border: 1px solid rgba(255,255,255,0.1); transform: translateY(150%); transition: 0.3s;
        }
        .cart-bar.show { transform: translateY(0); }
        .btn-view-cart { background: var(--primary); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.85rem; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(3px); z-index: 2000; display: none; align-items: flex-end; }
        .cart-modal { background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 25px; max-height: 80vh; display: flex; flex-direction: column; animation: slideUpSheet 0.3s; color: var(--text-dark); }
        .cart-item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .btn-qty { width: 30px; height: 30px; border-radius: 50%; background: #f1f5f9; display: flex; justify-content: center; align-items: center; font-weight: 700; }
        .btn-order-confirm { background: var(--primary); color: white; width: 100%; padding: 16px; border-radius: 16px; font-weight: 800; border: none; margin-top: 20px; font-size: 1rem; }

        /* Toast */
        #toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(40, 40, 40, 0.95); backdrop-filter: blur(10px); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; animation: slideInTop 0.3s; }
        .toast.success { border-left: 4px solid var(--success); }

        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes slideInTop { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">ƒê·∫∂NG NG√ÇN </div>
        
        <div class="header-right">
            <div id="table-title" class="badge-table">B√†n ...</div>
            <a href="/login.html" class="btn-login-nav">üîë</a>
        </div>
    </div>

    <div id="order-status-bar">
        <span class="status-dot"></span> ‚è≥ ƒê∆°n h√†ng ƒë√£ g·ª≠i & ƒëang ch·ªù x·ª≠ l√Ω...
    </div>

    <div class="category-scroll">
        <div class="cat-chip active" onclick="filter('all', this)">T·∫•t c·∫£</div>
        <div class="cat-chip" onclick="filter('Drink', this)">‚òï ƒê·ªì u·ªëng</div>
        <div class="cat-chip" onclick="filter('Snack', this)">üç∞ ƒÇn v·∫∑t</div>
    </div>

    <div id="menu" class="grid"></div>

    <div id="toast-box"></div>

    <div id="cart-ui" class="cart-bar" onclick="toggleCart()">
        <div class="cart-info">
            <span id="cart-count" style="font-size: 0.8rem; opacity: 0.7;">0 m√≥n</span>
            <span id="cart-total" style="font-weight: 700; font-size: 1.1rem;">0ƒë</span>
        </div>
        <div class="btn-view-cart">Gi·ªè h√†ng üõí</div>
    </div>

    <div id="cart-modal" class="modal-overlay">
        <div class="cart-modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0">Gi·ªè h√†ng c·ªßa b·∫°n</h3>
                <div onclick="toggleCart()" style="padding:10px; font-size:1.5rem;">‚úï</div>
            </div>
            <div id="cart-items-list" style="overflow-y:auto; flex:1;"></div>
            <div style="margin-top:auto">
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:700; margin-bottom:10px;">
                    <span>T·ªïng:</span> <span id="modal-total" style="color:var(--primary)">0ƒë</span>
                </div>
                <button class="btn-order-confirm" onclick="sendOrder()">X√ÅC NH·∫¨N G·ªåI M√ìN</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const params = new URLSearchParams(window.location.search);
        
        // [C·∫¨P NH·∫¨T] Logic hi·ªÉn th·ªã t√™n b√†n (H·ªó tr·ª£ Mang V·ªÅ = B√†n 0)
        const table = params.get('table') || '0'; 
        const displayTable = (table === '0') ? 'Qu·∫ßy' : `B√†n ${table}`;
        document.getElementById('table-title').innerText = displayTable;

        let cart = [];
        let allProducts = [];

        // Check tr·∫°ng th√°i ƒë∆°n pending
        if (localStorage.getItem(`status_${table}`) === 'pending') {
            document.getElementById('order-status-bar').style.display = 'block';
        }

        // --- FETCH S·∫¢N PH·∫®M ---
        fetch('/api/products').then(r => r.json()).then(products => {
            allProducts = products;
            renderMenu(products);
        });

        function renderMenu(list) {
            document.getElementById('menu').innerHTML = list.map(p => `
                <div class="card" onclick="updateQuantity('${p.name}', ${p.price}, 1)">
                    <div class="card-img-box"><img src="${p.image}" class="card-img" onerror="this.src='https://placehold.co/300x200?text=IMG'"></div>
                    <div class="card-body">
                        <div class="card-title">${p.name}</div>
                        <div class="card-price">${p.price.toLocaleString()}ƒë</div>
                        <button class="btn-add">Th√™m +</button>
                    </div>
                </div>
            `).join('');
        }

        function filter(cat, el) {
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderMenu(cat === 'all' ? allProducts : allProducts.filter(p => p.category === cat));
        }

        // --- CART LOGIC ---
        function updateQuantity(name, price, change) {
            const idx = cart.findIndex(i => i.productName === name);
            if (idx > -1) {
                cart[idx].quantity += change;
                if (cart[idx].quantity <= 0) cart.splice(idx, 1);
            } else if (change > 0) {
                cart.push({ productName: name, price: price, quantity: 1 });
                showToast(`ƒê√£ th√™m ${name}`, 'success');
            }
            updateCartUI();
        }

        function updateCartUI() {
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            
            const bar = document.getElementById('cart-ui');
            if(count > 0) bar.classList.add('show');
            else {
                bar.classList.remove('show');
                document.getElementById('cart-modal').style.display = 'none';
            }

            document.getElementById('cart-count').innerText = `${count} m√≥n`;
            document.getElementById('cart-total').innerText = total.toLocaleString() + 'ƒë';
            document.getElementById('modal-total').innerText = total.toLocaleString() + 'ƒë';

            document.getElementById('cart-items-list').innerHTML = cart.map(i => `
                <div class="cart-item-row">
                    <div><div style="font-weight:700">${i.productName}</div><div style="font-size:0.9rem; color:#888">${i.price.toLocaleString()}</div></div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="btn-qty" onclick="updateQuantity('${i.productName}', ${i.price}, -1)">-</div>
                        <div style="font-weight:700; width:20px; text-align:center;">${i.quantity}</div>
                        <div class="btn-qty" onclick="updateQuantity('${i.productName}', ${i.price}, 1)">+</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }
        document.getElementById('cart-modal').addEventListener('click', (e) => { if(e.target.id === 'cart-modal') toggleCart(); });

        function showToast(msg, type) {
            const box = document.getElementById('toast-box');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>‚úÖ</span> <span>${msg}</span>`;
            box.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 2000);
        }

        // --- G·ª¨I ƒê∆†N & X·ª¨ L√ù TR·∫†NG TH√ÅI ---
        function sendOrder() {
            if(cart.length === 0) return;
            
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            
            // G·ª≠i l√™n server
            socket.emit('send_order', { 
                tableNumber: table, 
                items: cart, 
                totalAmount: total, 
                isTakeAway: (table === '0') // N·∫øu table l√† "0" th√¨ ƒë√°nh d·∫•u l√† Mang v·ªÅ
            });

            // 1. Reset Gi·ªè h√†ng
            cart = []; 
            updateCartUI();
            toggleCart(); 

            // 2. Hi·ªán Toast & Thanh tr·∫°ng th√°i
            showToast('ƒê√£ g·ª≠i ƒë∆°n th√†nh c√¥ng! Vui l√≤ng ch·ªù.', 'success');
            document.getElementById('order-status-bar').style.display = 'block';
            
            // L∆∞u tr·∫°ng th√°i v√†o LocalStorage ƒë·ªÉ F5 kh√¥ng m·∫•t
            localStorage.setItem(`status_${table}`, 'pending');
        }

        // --- L·∫ÆNG NGHE S·ª∞ KI·ªÜN THANH TO√ÅN ---
        socket.on('order_paid_success', (order) => {
            // Ki·ªÉm tra xem ƒë∆°n ƒë∆∞·ª£c thanh to√°n c√≥ ph·∫£i c·ªßa b√†n m√¨nh kh√¥ng
            // L∆∞u √Ω: table v√† order.tableNumber c√≥ th·ªÉ l√† string ho·∫∑c number, so s√°nh == l√† an to√†n nh·∫•t
            if (order.tableNumber == table) {
                // 1. ·∫®n thanh tr·∫°ng th√°i
                document.getElementById('order-status-bar').style.display = 'none';
                
                // 2. X√≥a tr·∫°ng th√°i l∆∞u tr·ªØ
                localStorage.removeItem(`status_${table}`);
                
                // 3. Hi·ªán th√¥ng b√°o c·∫£m ∆°n
                showToast('‚úÖ ƒê∆°n h√†ng ƒë√£ thanh to√°n xong. C·∫£m ∆°n qu√Ω kh√°ch!', 'success');
                
                // 4. Rung ƒëi·ªán tho·∫°i b√°o hi·ªáu
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
        });
    </script>
</body>
</html>